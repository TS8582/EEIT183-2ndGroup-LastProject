<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>活動管理</title>
    <!-- 導航欄模板 -->
    <div th:replace="~{layout/backen_nav}"></div>
    <!-- 引入 Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <!-- 引入 Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <style>
        /* 自定義樣式 */
        body {
            background-color: #f8f9fa;
        }

        /* 側邊欄樣式 */
           .sidebar {
        position: fixed;
        top: 100px; /* 調整此值使其等於或略大於頂部導航欄的高度 */
        left: 0;
        bottom: 0;
        width: 200px;
        padding-top: 20px;
        background-color: #343a40;
        z-index: 99; /* 確保側欄在導航欄下方但在主內容上方 */
    }

        .sidebar .nav-link {
            color: #ced4da;
            padding: 10px 15px;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: #fff;
            background-color: rgba(255, 255, 255, .1);
        }

        /* 主內容區域樣式 */
        .content-wrapper {
            margin-left: 200px;
            /* 與側邊欄寬度相同 */
            padding: 20px;
        }

        /* 其他樣式保持不變 */
        .table th {
            background-color: #f1f3f5;
        }

        .btn-action {
            margin-right: 5px;
        }

        /* 優化搜尋框樣式 */
        .search-form {
            display: flex;
            align-items: center;
        }

        .search-form input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .search-form button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        /* 表格欄位樣式 */
        .table th,
        .table td {
            width: 150px;
            max-width: 150px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            vertical-align: top;
        }

        /* 操作列樣式 */
        .table td.actions {
            width: auto;
            white-space: nowrap;
        }

        /* 活動名稱列樣式 */
        .table td.event-name {
            width: 200px;
            max-width: 200px;
        }

        /* 活動描述列樣式 */
        .table td.event-description {
            width: 250px;
            max-width: 250px;
        }

        /* 自定義狀態標籤樣式 */
        .badge-success {
            color: #155724 !important;
            background-color: #d4edda !important;
        }

        .badge-warning {
            color: #856404 !important;
            background-color: #fff3cd !important;
        }

        .badge-secondary {
            color: #383d41 !important;
            background-color: #e2e3e5 !important;
        }

        /* 模態框樣式 */
        .modal-content {
            border-radius: 8px;
            border: none;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            border-bottom: 1px solid #e9ecef;
            padding: 1rem;
        }

        .modal-title {
            font-weight: bold;
        }

        /* 修改關閉按鈕樣式 */
        .modal-header .close {
            padding: 1rem;
            margin: -1rem -1rem -1rem auto;
            background: none;
            border: none;
            font-size: 1.5rem;
            opacity: 0.5;
            transition: opacity 0.15s;
        }

        .modal-header .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            border-top: 1px solid #e9ecef;
            padding: 1rem;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .search-form .input-group {
            width: 100%;
            max-width: 600px;
            /* 調整此值以改變整個搜尋欄的最大寬度 */
        }

        .search-form .form-control {
            height: 38px;
            /* 確保所有元素高度一致 */
        }

        .search-form .btn {
            height: 38px;
            padding-top: 0;
            padding-bottom: 0;
            line-height: 38px;
        }
        
        /* 調整選擇欄位的寬度 */
.search-form #searchField {
    width: auto;
    min-width: 120px; /* 調整此值以改變選擇欄位的最小寬度 */
    max-width: 150px; /* 調整此值以改變選擇欄位的最大寬度 */
}
    </style>
</head>

<body class="h-screen flex flex-col w-screen">
<!-- 側邊欄 -->
<div class="sidebar">
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="nav-link" href="/PlayCentric/events/listEvents">
                <i class="fas fa-calendar-alt mr-2"></i>活動管理
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/PlayCentric/eventSignup/manage">
                <i class="fas fa-users mr-2"></i>報名管理
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/PlayCentric/eventVotes/manage">
                <i class="fas fa-vote-yea mr-2"></i>投票管理
            </a>
        </li>
    </ul>
</div>

    <!-- 主要內容區域 -->
    <div class="content-wrapper">
        <div id="mainContent">
            <!-- 活動管理內容 -->
            <div id="eventManagementContent">
                <h1 class="mb-4">活動管理</h1>
                <div class="row mb-3">
                    <!-- 新增活動按鈕 -->
                    <div class="col-md-6">
                        <button class="btn btn-primary mr-2" onclick="openCreateEventForm()">
                            <i class="fas fa-plus"></i> 新增活動
                        </button>
                    </div>
                    <!-- 搜尋活動表單 -->
                    <form class="search-form mb-3" onsubmit="searchEvents(); return false;">
                        <div class="input-group">
                            <select class="form-control col-md-2" id="searchField">
                                <option value="all">全部欄位</option>
                                <option value="eventName">活動名稱</option>
                                <option value="eventDescription">活動描述</option>
                                <option value="eventStatus">活動狀態</option>
                            </select>
                            <input type="text" class="form-control" id="searchInput" placeholder="輸入搜尋關鍵字">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="submit">
                                    <i class="fas fa-search"></i> 搜尋
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- 活動列表表格 -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>活動名稱</th>
                                    <th>活動描述</th>
                                    <th>開始時間</th>
                                    <th>結束時間</th>
                                    <th>報名截止時間</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="eventList">
                                <tr th:each="event : ${allEvents}">
                                    <td class="event-name" th:text="${event.eventName}"></td>
                                    <td class="event-description" th:text="${event.eventDescription}"></td>
                                    <td><span
                                            th:text="${#temporals.format(event.eventStartTime, 'yyyy年MM月dd日 HH:mm:ss')}"></span>
                                    </td>
                                    <td><span
                                            th:text="${#temporals.format(event.eventEndTime, 'yyyy年MM月dd日 HH:mm:ss')}"></span>
                                    </td>
                                    <td><span
                                            th:text="${#temporals.format(event.eventSignupDeadLine, 'yyyy年MM月dd日 HH:mm:ss')}"></span>
                                    </td>
                                    <td>
                                        <span id="span1"
                                            th:class="${event.eventStatus == 0 ? 'badge badge-warning' : (event.eventStatus == 1 ? 'badge badge-success' : 'badge badge-secondary')}"
                                            th:text="${event.eventStatus == 0 ? '未開始' : (event.eventStatus == 1 ? '進行中' : '已結束')}">
                                        </span>
                                    </td>
                                    <td class="actions">
                                        <button class="btn btn-info btn-sm btn-action edit-btn"
                                            th:attr="data-event-id=${event.eventId}">
                                            <i class="fas fa-edit"></i> 編輯
                                        </button>
                                        <form method="post" th:action="@{/events/delete}" style="display: inline;">
                                            <input type="hidden" name="eventId" th:value="${event.eventId}" />
                                            <button type="submit" class="btn btn-danger btn-sm btn-action"
                                                onclick="return confirm('確定刪除嗎?')">
                                                <i class="fas fa-trash-alt"></i> 刪除
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 報名管理內容 -->
                <div id="signupManagementContent" style="display: none;">
                    <!-- 報名管理的內容將通過 AJAX 加載 -->
                </div>
            </div>

            <!-- 活動表單模態框 -->
            <div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="eventModalLabel">活動詳情</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form id="eventForm" method="post" th:action="@{/events/addPost}">
                            <div class="modal-body">
                                <!-- 活動表單字段 -->
                                <div class="form-group">
                                    <label for="eventName">活動名稱</label>
                                    <input type="text" class="form-control" id="eventName" name="eventName" required>
                                </div>
                                <div class="form-group">
                                    <label for="eventDescription">活動描述</label>
                                    <textarea class="form-control" id="eventDescription" name="eventDescription"
                                        rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="eventStartTime">開始時間</label>
                                    <input type="datetime-local" class="form-control datetime" id="eventStartTime"
                                        name="eventStartTime" required>
                                </div>
                                <div class="form-group">
                                    <label for="eventEndTime">結束時間</label>
                                    <input type="datetime-local" class="form-control datetime" id="eventEndTime"
                                        name="eventEndTime" required>
                                </div>
                                <div class="form-group">
                                    <label for="eventSignupDeadLine">報名截止時間</label>
                                    <input type="datetime-local" class="form-control datetime" id="eventSignupDeadLine"
                                        name="eventSignupDeadLine" required>
                                </div>
                                <div class="form-group">
                                    <label for="eventStatus">活動狀態</label>
                                    <select class="form-control" id="eventStatus" name="eventStatus" required>
                                        <option value="0">未開始</option>
                                        <option value="1" selected>進行中</option>
                                        <option value="2">已結束</option>
                                    </select>
                                </div>
                                <input type="hidden" id="eventId" name="eventId">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                                <button type="submit" class="btn btn-primary" id="saveEventBtn">保存</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- jQuery 和 Bootstrap JavaScript -->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script th:src="@{/js/axios.min.js}"></script>

        <div id="errMsg" th:if="${errMsg}" style="display: none;">[[${errMsg}]]</div>

        <script th:inline="javascript">
            // 後端 API URL
            const findEventUrl = "/PlayCentric/events/get/";
            const createEventUrl = "/PlayCentric/events/createPost";
            const updateEventUrl = "/PlayCentric/events/updatePost";

            // 顯示錯誤訊息
            if ($('#errMsg').length > 0) {
                alert($('#errMsg').text());
            }

            // 編輯按鈕點擊事件處理
            $('#eventList').on('click', '.edit-btn', function () {
                showEventInfo($(this).data('event-id'));
            });

            // 顯示活動詳情
            function showEventInfo(eventId) {
                axios.get(findEventUrl + eventId)
                    .then(res => {
                        console.log(res.data);
                        showUpdateModal(res.data);
                    })
                    .catch(err => {
                        console.error("獲取活動詳情失敗:", err);
                        alert("獲取活動詳情失敗，請稍後再試");
                    });
            }

            // 顯示編輯活動的互動視窗
            function showUpdateModal(data) {
                $('#eventForm').attr('action', updateEventUrl);
                $('#eventModal .modal-title').text('編輯活動資訊');
                $('#eventModal #eventId').val(data.eventId);
                $('#eventModal #eventName').val(data.eventName || '');
                $('#eventModal #eventDescription').val(data.eventDescription || '');

                // 使用新的格式化函數來設置日期時間
                $('#eventModal #eventStartTime').val(formatDateTimeForInput(data.eventStartTime));
                $('#eventModal #eventEndTime').val(formatDateTimeForInput(data.eventEndTime));
                $('#eventModal #eventSignupDeadLine').val(formatDateTimeForInput(data.eventSignupDeadLine));

                $('#eventModal #eventStatus').val(data.eventStatus || '0');
                $('#eventModal').modal('show');
            }

            // 格式化日期時間為輸入框所需的格式
            function formatDateTimeForInput(dateTimeString) {
                if (!dateTimeString) return '';

                // 創建一個新的日期對象
                let date = new Date(dateTimeString);

                // 格式化日期和時間
                let year = date.getFullYear();
                let month = (date.getMonth() + 1).toString().padStart(2, '0');
                let day = date.getDate().toString().padStart(2, '0');
                let hours = date.getHours().toString().padStart(2, '0');
                let minutes = date.getMinutes().toString().padStart(2, '0');

                // 返回 YYYY-MM-DDTHH:mm 格式的字符串
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            // 表單提交處理
            $('#eventForm').submit(function (event) {
                event.preventDefault();

                const startTime = new Date($('#eventStartTime').val());
                const endTime = new Date($('#eventEndTime').val());
                const signupDeadline = new Date($('#eventSignupDeadLine').val());

                // 驗證邏輯
                if (endTime <= startTime) {
                    alert("結束時間必須在開始時間之後");
                    return false;
                }

                if (signupDeadline >= endTime) {
                    alert("報名截止時間必須在結束時間之前");
                    return false;
                }

                if (signupDeadline <= startTime) {
                    alert("報名截止時間必須在開始時間之後");
                    return false;
                }

                this.submit();
            });

            // 打開創建活動表單
            function openCreateEventForm() {
                $('#eventForm').attr('action', createEventUrl);
                $('#eventForm .datetime').attr('type', 'datetime-local');
                $('#eventModal').modal('show');
                $('#eventForm').trigger('reset');
                $('#eventId').val('');
                $('#eventModal .modal-title').text('新增活動');
            }

            // 搜尋活動
            function searchEvents() {
                let searchQuery = $('#searchInput').val().toLowerCase();
                let searchField = $('#searchField').val();
                $('#eventList tr').each(function () {
                    let row = $(this);
                    let show = false;
                    if (searchField === 'all') {
                        show = row.text().toLowerCase().includes(searchQuery);
                    } else {
                        let index = {
                            'eventName': 0,
                            'eventDescription': 1,
                            'eventStatus': 5
                        }[searchField];
                        let cellText = row.find('td').eq(index).text().toLowerCase();
                        show = cellText.includes(searchQuery);
                    }
                    row.toggle(show);
                });
            }

            // 處理ENTER搜尋
            $('#searchEventInput').keypress(function (event) {
                if (event.which === 13) {
                    event.preventDefault();
                    searchEvents();
                }
            });

            // 確保互動視窗可以正確關閉
            $('#eventModal .close, #eventModal .btn-secondary').click(function () {
                $('#eventModal').modal('hide');
            });
        </script>
</body>

</html>