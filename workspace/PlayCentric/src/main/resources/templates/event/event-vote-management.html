<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>投票管理</title>
    <!-- 導航欄模板 -->
    <div th:replace="~{layout/backen_nav}"></div>
    <!-- 引入 Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <!-- 引入 Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入 Moment.js 用於日期處理 -->
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <!-- 引入 Chart.js 的 Moment 適配器 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <!-- 引入提示用工具 -->
    <script th:src="@{/js/utils/doAlertJQ.js}"></script>
    <style>
        /* 基本頁面樣式 */
        body {
            background-color: #f8f9fa;
            padding-top: 56px; /* 為固定導航欄留出空間，根據實際導航欄高度調整 */
        }
        /* 固定導航欄樣式 */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        /* 側邊欄樣式 */
        .sidebar {
            position: fixed;
            top: 56px; /* 從導航欄下方開始，根據實際導航欄高度調整 */
            left: 0;
            bottom: 0;
            width: 200px;
            padding-top: 20px;
            background-color: #343a40;
            z-index: 100;
            overflow-y: auto;
        }
        .sidebar .nav-link {
            color: #ced4da;
            padding: 10px 15px;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: #fff;
            background-color: rgba(255, 255, 255, .1);
        }
        /* 主內容區域樣式 */
        .content-wrapper {
            margin-left: 200px;
            padding: 20px;
            padding-top: 20px; /* 調整頂部間距 */
        }
        /* 表格樣式 */
        .table {
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .table th {
            background-color: #f1f3f5;
        }
        /* 統計卡片樣式 */
        .stat-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .stat-card h3 {
            margin-bottom: 10px;
            color: #343a40;
        }
        .stat-card .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        /* 圖表容器樣式 */
        .chart-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            height: 300px;
        }
        /* 狀態下拉選單樣式 */
        .status-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3E%3Cpath fill='%23343a40' d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' transform='rotate(90 4 4)'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right .75rem center;
            background-size: 8px 10px;
            padding-right: 1.5rem;
        }
        /* 有效投票狀態樣式 */
        .status-valid { 
            color: #28a745; 
        }
        /* 待審核投票狀態樣式 */
        .status-pending { 
            color: #ffc107; 
        }
        /* 搜索表單樣式 */
        .search-form {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        /* 操作按鈕樣式 */
        .action-btn {
            margin-right: 5px;
        }
        

    </style>
</head>

<body>
    <!-- 側邊欄 -->
    <div class="sidebar">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="/PlayCentric/events/listEvents">
                    <i class="fas fa-calendar-alt mr-2"></i>活動管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/PlayCentric/eventSignup/manage">
                    <i class="fas fa-users mr-2"></i>報名管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/PlayCentric/eventVotes/manage">
                    <i class="fas fa-vote-yea mr-2"></i>投票管理
                </a>
            </li>
        </ul>
    </div>

    <!-- 主要內容區域 -->
    <div class="content-wrapper">
        <h1 class="mb-4">投票管理</h1>

        <!-- 統計信息區 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <h3>總投票數</h3>
                    <div class="stat-value" id="totalVotes">Loading...</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h3>有效投票</h3>
                    <div class="stat-value" id="validVotes">Loading...</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h3>待審核投票</h3>
                    <div class="stat-value" id="pendingVotes">Loading...</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h3>投票參與人數</h3>
                    <div class="stat-value" id="uniqueVoters">Loading...</div>
                </div>
            </div>
        </div>

        <!-- 圖表區域 -->
        <div class="row mb-4">
			<!-- 圓餅圖 -->
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="voteDistributionChart"></canvas>
                </div>
            </div>
            <!-- 投票趨勢圖表 -->
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="voteTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 搜索表單 -->
        <form class="search-form mb-3" onsubmit="searchVotes(); return false;">
            <div class="input-group">
                <select class="form-control" id="searchField">
                    <option value="all">全部欄位</option>
                    <option value="voteId">投票ID</option>
                    <option value="memberName">會員名稱</option>
                    <option value="eventName">活動名稱</option>
                    <option value="workTitle">作品名稱</option>
                </select>
                <input type="text" class="form-control" id="searchInput" placeholder="輸入搜尋關鍵字">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="submit">
                        <i class="fas fa-search"></i> 搜尋
                    </button>
                </div>
            </div>
        </form>

        <!-- 投票列表 -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>投票ID</th>
                        <th>會員名稱</th>
                        <th>活動名稱</th>
                        <th>作品名稱</th>
                        <th>投票時間</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="voteList">
                    <!-- 投票數據通過 JavaScript 動態填充 -->
                </tbody>
            </table>
        </div>

        <!-- 分頁控件 -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 動態生成分頁按鈕 -->
            </ul>
        </nav>
    </div>

    <!-- 引入必要的 JavaScript 文件 -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script th:src="@{/js/axios.min.js}"></script>

    <script th:inline="javascript">
    // ===== 全局變量 =====
    let currentPage = 1;
    const itemsPerPage = 10;
    let allVotes = [];
    let originalVotes = [];

    // ===== 頁面初始化 =====
    $(document).ready(function() {
        loadVotes();
        loadStatistics();
        initCharts();

        // 綁定搜索框回車事件
        $('#searchInput').keypress(function(event) {
            if (event.which === 13) {
                event.preventDefault();
                searchVotes();
            }
        });
    });

    // ===== 數據加載函數 =====

    // 加載所有投票數據
    function loadVotes() {
        axios.get('/PlayCentric/eventVotes/api/all')
            .then(response => {
                allVotes = response.data;
                originalVotes = [...allVotes];
                displayVotes(currentPage);
                setupPagination();
            })
            .catch(error => {
                console.error('載入投票數據失敗:', error);
                doAlert('載入投票數據失敗，請稍後再試。');
            });
    }

    // 加載統計數據
    function loadStatistics() {
        axios.get('/PlayCentric/eventVotes/api/statistics')
            .then(response => {
                const stats = response.data;
                updateStatCards(stats);
                updateVoteDistributionChart(stats);
                updateVoteTrendChart(stats.voteTrend);
            })
            .catch(error => {
                console.error('加載統計信息失敗:', error);
                doAlert('加載統計信息失敗，請稍後再試。');
            });
    }

    // ===== 顯示函數 =====

    // 顯示投票列表
    function displayVotes(page) {
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageVotes = allVotes.slice(start, end);

        const voteList = $('#voteList');
        voteList.empty();

        pageVotes.forEach(vote => {
            voteList.append(`
                <tr>
                    <td>${vote.voteId}</td>
                    <td>${vote.member.memName}</td>
                    <td>${vote.event.eventName}</td>
                    <td>${vote.eventSignup.workTitle}</td>
                    <td>${new Date(vote.voteTime).toLocaleString()}</td>
                    <td>
                        <select class="form-control form-control-sm status-select ${vote.eventVoteStatus === 1 ? 'status-valid' : 'status-pending'}" 
                                onchange="updateVoteStatus(${vote.voteId}, this.value)">
                            <option value="1" ${vote.eventVoteStatus === 1 ? 'selected' : ''}>有效</option>
                            <option value="0" ${vote.eventVoteStatus === 0 ? 'selected' : ''}>待審核</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm action-btn" onclick="confirmDeleteVote(${vote.voteId})">
                            <i class="fas fa-trash"></i> 刪除
                        </button>
                    </td>
                </tr>
            `);
        });
    }

    // ===== 分頁相關函數 =====

    // 設置分頁控件
    function setupPagination() {
        const totalPages = Math.ceil(allVotes.length / itemsPerPage);
        const pagination = $('#pagination');
        pagination.empty();

        // 添加上一頁按鈕
        pagination.append(`
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一頁</a>
            </li>
        `);

        // 添加頁碼按鈕
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                pagination.append(`
                    <li class="page-item ${currentPage === i ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `);
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
            }
        }

        // 添加下一頁按鈕
        pagination.append(`
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一頁</a>
            </li>
        `);
    }

    // 切換頁面
    function changePage(page) {
        const totalPages = Math.ceil(allVotes.length / itemsPerPage);
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        displayVotes(currentPage);
        setupPagination();
    }

    // ===== 搜索相關函數 =====

    // 搜索投票
    function searchVotes() {
        const searchField = $('#searchField').val();
        const searchInput = $('#searchInput').val().toLowerCase();

        if (searchInput.trim() === '') {
            allVotes = [...originalVotes]; // 如果搜索框為空，恢復所有投票數據
        } else {
            allVotes = originalVotes.filter(vote => {
                if (searchField === 'all') {
                    // 在所有欄位中搜索
                    return Object.values(vote).some(value => 
                        String(value).toLowerCase().includes(searchInput)
                    ) ||
                    vote.member.memName.toLowerCase().includes(searchInput) ||
                    vote.event.eventName.toLowerCase().includes(searchInput) ||
                    vote.eventSignup.workTitle.toLowerCase().includes(searchInput);
                } else {
                    // 根據選擇的欄位進行搜索
                    switch (searchField) {
                        case 'voteId':
                            return vote.voteId.toString().includes(searchInput);
                        case 'memberName':
                            return vote.member.memName.toLowerCase().includes(searchInput);
                        case 'eventName':
                            return vote.event.eventName.toLowerCase().includes(searchInput);
                        case 'workTitle':
                            return vote.eventSignup.workTitle.toLowerCase().includes(searchInput);
                        default:
                            return false;
                    }
                }
            });
        }

        currentPage = 1; // 重置到第一頁
        displayVotes(currentPage);
        setupPagination();
    }

    // ===== 投票狀態更新函數 =====

    // 更新投票狀態
    function updateVoteStatus(voteId, newStatus) {
        axios.put(`/PlayCentric/eventVotes/api/${voteId}`, { eventVoteStatus: newStatus })
            .then(response => {
                doAlert('投票狀態更新成功');
                loadVotes(); // 重新加載投票列表
                loadStatistics(); // 更新統計信息
                // 更新參賽作品的票數（前端處理）
                updateEntryVoteCount(response.data.eventSignup.signupId, response.data.eventVoteStatus);
            })
            .catch(error => {
                console.error('更新投票狀態失敗:', error);
                doAlert('更新投票狀態失敗，請稍後再試');
            });
    }

    // 更新參賽作品的票數（前端處理）
    function updateEntryVoteCount(signupId, voteStatus) {
        const voteCountElement = document.querySelector(`#entry-${signupId} .vote-count`);
        if (voteCountElement) {
            let currentCount = parseInt(voteCountElement.textContent);
            if (voteStatus === 1) { // 有效票
                currentCount++;
            } else { // 待審核票
                currentCount = Math.max(0, currentCount - 1); // 確保票數不會變成負數
            }
            voteCountElement.textContent = currentCount;
        }
    }

    // ===== 投票刪除相關函數 =====

    // 確認刪除投票
    function confirmDeleteVote(voteId) {
        if (confirm('確定要刪除這條投票記錄嗎？此操作不可撤銷。')) {
            deleteVote(voteId);
        }
    }

    // 刪除投票
    function deleteVote(voteId) {
        axios.delete(`/PlayCentric/eventVotes/api/${voteId}`)
            .then(() => {
                doAlert('投票記錄已成功刪除');
                loadVotes(); // 重新加載投票列表
                loadStatistics(); // 更新統計信息
            })
            .catch(error => {
                console.error('刪除投票失敗:', error);
                doAlert('刪除投票失敗，請稍後再試。');
            });
    }

    // ===== 統計資訊更新函數 =====

    // 更新統計卡片
    function updateStatCards(stats) {
        $('#totalVotes').text(stats.totalVotes || 0);
        $('#validVotes').text(stats.validVotes || 0);
        $('#pendingVotes').text(stats.pendingVotes || 0);
        $('#uniqueVoters').text(stats.activeUsers || 0);
    }

    // ===== 圖表相關函數 =====

    // 初始化圖表
    function initCharts() {
        // 初始化投票分佈圖表
        const voteDistributionCtx = document.getElementById('voteDistributionChart').getContext('2d');
        window.voteDistributionChart = new Chart(voteDistributionCtx, {
            type: 'doughnut',
            data: {
                labels: ['有效投票', '待審核投票'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#28a745', '#ffc107'],
                    borderColor: ['#ffffff', '#ffffff'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                title: {
                    display: true,
                    text: '投票狀態分佈',
                    fontSize: 18
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        fontSize: 14
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });

        // 初始化投票趨勢圖表
        const voteTrendCtx = document.getElementById('voteTrendChart').getContext('2d');
        window.voteTrendChart = new Chart(voteTrendCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: '每日投票數',
                    data: [],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'YYYY-MM-DD'
                            }
                        },
                        title: {
                            display: true,
                            text: '日期',
                            fontSize: 14
                        },
                        ticks: {
                            fontSize: 12
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '投票數',
                            fontSize: 14
                        },
                        ticks: {
                            fontSize: 12,
                            stepSize: 1,
                            callback: function(value) {
                                if (value % 1 === 0) {
                                    return value;
                                }
                            }
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: '近7天投票趨勢',
                        fontSize: 18
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    legend: {
                        labels: {
                            fontSize: 14
                        }
                    }
                }
            }
        });
    }

    // 更新投票分佈圖表
    function updateVoteDistributionChart(stats) {
        if (window.voteDistributionChart && stats) {
            window.voteDistributionChart.data.datasets[0].data = [
                stats.validVotes,
                stats.pendingVotes
            ];
            window.voteDistributionChart.update();
        }
    }

    // 更新投票趨勢圖表
    function updateVoteTrendChart(voteTrend) {
        if (window.voteTrendChart && voteTrend && voteTrend.length > 0) {
            const data = voteTrend.map(item => ({
                x: moment(item.date).format('YYYY-MM-DD'),
                y: item.count
            }));
            window.voteTrendChart.data.datasets[0].data = data;
            window.voteTrendChart.update();
        }
    }

    </script>
</body>
</html>