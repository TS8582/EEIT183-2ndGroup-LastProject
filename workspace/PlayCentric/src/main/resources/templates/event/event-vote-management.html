<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>投票管理</title>
    <!-- 導航欄模板 -->
    <div th:replace="~{layout/backen_nav}"></div>
    <!-- 引入 Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <!-- 引入 Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 基本頁面樣式 */
        body {
            background-color: #f8f9fa;
        }

        /* 側邊欄樣式 */
        .sidebar {
            position: fixed;
            top: 100px;
            left: 0;
            bottom: 0;
            width: 200px;
            padding-top: 20px;
            background-color: #343a40;
            z-index: 99;
        }

        .sidebar .nav-link {
            color: #ced4da;
            padding: 10px 15px;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: #fff;
            background-color: rgba(255, 255, 255, .1);
        }

        /* 主內容區域樣式 */
        .content-wrapper {
            margin-left: 200px;
            padding: 20px;
        }

        /* 表格樣式 */
        .table {
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .table th {
            background-color: #f1f3f5;
        }

        /* 按鈕樣式 */
        .btn-action {
            margin-right: 5px;
        }

        /* 搜索表單樣式 */
        .search-form {
            margin-bottom: 20px;
        }

        .search-form .input-group {
            width: 100%;
            max-width: 600px;
        }

        /* 圖表容器樣式 */
        .chart-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        /* 統計卡片樣式 */
        .stat-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stat-card h3 {
            margin-bottom: 10px;
            color: #343a40;
        }

        .stat-card .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>

<body class="h-screen flex flex-col w-screen">
    <!-- 側邊欄 -->
    <div class="sidebar">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="/PlayCentric/events/listEvents">
                    <i class="fas fa-calendar-alt mr-2"></i>活動管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/PlayCentric/eventSignup/manage">
                    <i class="fas fa-users mr-2"></i>報名管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/PlayCentric/eventVotes/manage">
                    <i class="fas fa-vote-yea mr-2"></i>投票管理
                </a>
            </li>
        </ul>
    </div>

    <!-- 主要內容區域 -->
    <div class="content-wrapper">
        <h1 class="mb-4">投票管理</h1>

        <!-- 統計信息區 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <h3>總投票數</h3>
                    <div class="stat-value" id="totalVotes">Loading...</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <h3>活躍用戶數</h3>
                    <div class="stat-value" id="activeUsers">Loading...</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <h3>平均每人投票數</h3>
                    <div class="stat-value" id="avgVotesPerUser">Loading...</div>
                </div>
            </div>
        </div>

        <!-- 圖表區域 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="voteDistributionChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="voteTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 搜索表單 -->
        <form class="search-form mb-3" onsubmit="searchVotes(); return false;">
            <div class="input-group">
                <select class="form-control col-md-2" id="searchField">
                    <option value="all">全部欄位</option>
                    <option value="voteId">投票ID</option>
                    <option value="memberName">會員名稱</option>
                    <option value="eventName">活動名稱</option>
                    <option value="signupName">報名作品</option>
                </select>
                <input type="text" class="form-control" id="searchInput" placeholder="輸入搜尋關鍵字">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="submit">
                        <i class="fas fa-search"></i> 搜尋
                    </button>
                </div>
            </div>
        </form>

        <!-- 投票列表 -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>投票ID</th>
                        <th>會員名稱</th>
                        <th>活動名稱</th>
                        <th>報名作品</th>
                        <th>投票時間</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="voteList">
                    <!-- 動態載入投票數據 -->
                </tbody>
            </table>
        </div>

        <!-- 分頁控件 -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 動態生成分頁按鈕 -->
            </ul>
        </nav>
    </div>

    <!-- 投票詳情模態框 -->
    <div class="modal fade" id="voteDetailModal" tabindex="-1" role="dialog" aria-labelledby="voteDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="voteDetailModalLabel">投票詳情</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="voteDetailContent">
                    <!-- 動態載入投票詳情 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-danger" id="deleteVoteBtn">刪除投票</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入必要的 JavaScript 文件 -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script th:src="@{/js/axios.min.js}"></script>

    <script th:inline="javascript">
    // 定義全局變量
    let currentPage = 1;
    const itemsPerPage = 10;
    let allVotes = [];

    // 頁面加載完成後執行的函數
    $(document).ready(function() {
        loadVotes();
        loadStatistics();
        initCharts();
    });

    // 加載投票數據
    function loadVotes() {
        axios.get('/PlayCentric/eventVotes/api/all')
            .then(response => {
                allVotes = response.data;
                displayVotes(currentPage);
                setupPagination();
            })
            .catch(error => {
                console.error('載入投票數據失敗:', error);
                alert('載入投票數據失敗，請稍後再試。');
            });
    }

    // 顯示指定頁的投票數據
    function displayVotes(page) {
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageVotes = allVotes.slice(start, end);

        const voteList = $('#voteList');
        voteList.empty();

        pageVotes.forEach(vote => {
            voteList.append(`
                <tr>
                    <td>${vote.voteId}</td>
                    <td>${vote.member.memName}</td>
                    <td>${vote.event.eventName}</td>
                    <td>${vote.eventSignup.workTitle}</td>
                    <td>${new Date(vote.voteTime).toLocaleString()}</td>
                    <td>
                        <span class="badge ${vote.eventVoteStatus === 1 ? 'badge-success' : 'badge-warning'}">
                            ${vote.eventVoteStatus === 1 ? '有效' : '待審核'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-info btn-sm btn-action" onclick="showVoteDetail(${vote.voteId})">
                            <i class="fas fa-eye"></i> 查看
                        </button>
                    </td>
                </tr>
            `);
        });
    }

    // 設置分頁控件
    function setupPagination() {
        const totalPages = Math.ceil(allVotes.length / itemsPerPage);
        const pagination = $('#pagination');
        pagination.empty();

        // 上一頁按鈕
        pagination.append(`
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一頁</a>
            </li>
        `);

        // 頁碼按鈕
        for (let i = 1; i <= totalPages; i++) {
            pagination.append(`
                <li class="page-item ${currentPage === i ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `);
        }

        // 下一頁按鈕
        pagination.append(`
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一頁</a>
            </li>
        `);
    }

    // 切換頁面
    function changePage(page) {
        if (page < 1 || page > Math.ceil(allVotes.length / itemsPerPage)) {
            return;
        }
        currentPage = page;
        displayVotes(currentPage);
        setupPagination();
    }

    // 顯示投票詳情
    function showVoteDetail(voteId) {
        const vote = allVotes.find(v => v.voteId === voteId);
        if (!vote) {
            alert('找不到指定的投票記錄');
            return;
        }

        const detailContent = `
            <p><strong>投票ID:</strong> ${vote.voteId}</p>
            <p><strong>會員名稱:</strong> ${vote.member.memName}</p>
            <p><strong>活動名稱:</strong> ${vote.event.eventName}</p>
            <p><strong>報名作品:</strong> ${vote.eventSignup.workTitle}</p>
            <p><strong>投票時間:</strong> ${new Date(vote.voteTime).toLocaleString()}</p>
            <p><strong>狀態:</strong> ${vote.eventVoteStatus === 1 ? '有效' : '待審核'}</p>
        `;

        $('#voteDetailContent').html(detailContent);
        $('#deleteVoteBtn').attr('onclick', `deleteVote(${vote.voteId})`);
        $('#voteDetailModal').modal('show');
    }

    // 刪除投票
    function deleteVote(voteId) {
        if (confirm('確定要刪除這條投票記錄嗎？此操作不可撤銷。')) {
            axios.delete(`/PlayCentric/eventVotes/api/${voteId}`)
                .then(() => {
                    alert('投票記錄已成功刪除');
                    $('#voteDetailModal').modal('hide');
                    loadVotes(); // 重新加載投票列表
                    loadStatistics(); // 更新統計信息
                })
                .catch(error => {
                    console.error('刪除投票失敗:', error);
                    alert('刪除投票失敗，請稍後再試。');
                });
        }
    }

    // 搜索投票
    function searchVotes() {
        const searchField = $('#searchField').val();
        const searchInput = $('#searchInput').val().toLowerCase();

        const filteredVotes = allVotes.filter(vote => {
            if (searchField === 'all') {
                return Object.values(vote).some(value => 
                    String(value).toLowerCase().includes(searchInput)
                );
            } else {
                switch (searchField) {
                    case 'voteId':
                        return vote.voteId.toString().includes(searchInput);
                    case 'memberName':
                        return vote.member.memName.toLowerCase().includes(searchInput);
                    case 'eventName':
                        return vote.event.eventName.toLowerCase().includes(searchInput);
                    case 'signupName':
                        return vote.eventSignup.workTitle.toLowerCase().includes(searchInput);
                    default:
                        return false;
                }
            }
        });

        // 更新顯示的投票列表
        currentPage = 1;
        allVotes = filteredVotes;
        displayVotes(currentPage);
        setupPagination();
    }

    // 加載統計信息
    function loadStatistics() {
        axios.get('/PlayCentric/eventVotes/api/statistics')
            .then(response => {
                const stats = response.data;
                $('#totalVotes').text(stats.totalVotes);
                $('#activeUsers').text(stats.activeUsers);
                $('#avgVotesPerUser').text(stats.avgVotesPerUser.toFixed(2));
                updateCharts(stats);
            })
            .catch(error => {
                console.error('加載統計信息失敗:', error);
                alert('加載統計信息失敗，請稍後再試。');
            });
    }

    // 初始化圖表
    function initCharts() {
        // 投票分佈圖
        new Chart(document.getElementById('voteDistributionChart'), {
            type: 'pie',
            data: {
                labels: ['有效票', '待審核票'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#36a2eb', '#ff6384']
                }]
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: '投票狀態分佈'
                }
            }
        });

        // 投票趨勢圖
        new Chart(document.getElementById('voteTrendChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '每日投票數',
                    data: [],
                    borderColor: '#36a2eb',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: '投票趨勢'
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            unit: 'day'
                        }
                    }],
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    }

    // 更新圖表
    function updateCharts(stats) {
        // 更新投票分佈圖
        const distributionChart = Chart.getChart('voteDistributionChart');
        distributionChart.data.datasets[0].data = [stats.validVotes, stats.pendingVotes];
        distributionChart.update();

        // 更新投票趨勢圖
        const trendChart = Chart.getChart('voteTrendChart');
        trendChart.data.labels = stats.voteTrend.map(item => item.date);
        trendChart.data.datasets[0].data = stats.voteTrend.map(item => item.count);
        trendChart.update();
    }

    // 處理ENTER鍵搜索
    $('#searchInput').keypress(function(event) {
        if (event.which === 13) {
            event.preventDefault();
            searchVotes();
        }
    });

    // 確保模態框可以正確關閉
    $('.modal').on('hidden.bs.modal', function() {
        $(this).find('form').trigger('reset');
    });

    // 為所有關閉按鈕添加事件監聽器
    $('.modal .close, .modal .btn-secondary').click(function() {
        $(this).closest('.modal').modal('hide');
    });
</script>
</body>
</html>