<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>投票管理</title>
    <!-- 導航欄模板 -->
    <div th:replace="~{layout/backen_nav}"></div>
    <!-- 引入 Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <!-- 引入 Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入 Moment.js -->
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <!-- 引入 Chart.js Adapter for Moment.js -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <!-- 引入提示用工具 -->
    <script th:src="@{/js/utils/doAlertJQ.js}"></script>
    <style>
        /* ===== 基本頁面佈局 ===== */
        body {
            background-color: #f8f9fa;
            padding-top: 56px;
        }
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        /* ===== 側邊欄樣式 ===== */
        .sidebar {
            position: fixed;
            top: 100px;
            left: 0;
            bottom: 0;
            width: 200px;
            padding-top: 20px;
            background-color: #343a40;
            z-index: 100;
        }
        .sidebar .nav-link {
            color: #ced4da;
            padding: 10px 15px;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: #fff;
            background-color: rgba(255, 255, 255, .1);
        }
        /* ===== 主要內容區域樣式 ===== */
        .content-wrapper {
            margin-left: 200px;
            padding: 20px;
            padding-top: 20px;
        }
        /* ===== 表格樣式 ===== */
        .table {
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .table th {
            background-color: #f1f3f5;
        }
        /* ===== 統計卡片樣式 ===== */
        .stat-cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .stat-card-large {
            flex-basis: 100%;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
        }
        .stat-card-small {
            flex-basis: calc(25% - 15px);
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
        }
        .stat-card-large h3,
        .stat-card-small h3 {
            margin-bottom: 10px;
            color: #343a40;
            font-size: 1.2rem;
        }
        .stat-card-large .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #007bff;
        }
        .stat-card-small .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #007bff;
        }
        /* ===== 圖表容器樣式 ===== */
        .chart-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            height: 500px;
        }
        /* ===== 狀態選擇下拉框樣式 ===== */
        .status-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3E%3Cpath fill='%23343a40' d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' transform='rotate(90 4 4)'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right .75rem center;
            background-size: 8px 10px;
            padding-right: 1.5rem;
        }
        .status-valid {
            color: #28a745;
        }
        .status-pending {
            color: #dc3545;
        }
        /* ===== 搜索表單樣式 ===== */
        .search-form {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        /* ===== 操作按鈕樣式 ===== */
        .action-btn {
            margin-right: 5px;
        }
        /* ===== 響應式設計 ===== */
        @media (max-width: 768px) {
            .stat-card-small {
                flex-basis: calc(50% - 10px);
            }
        }
    </style>
</head>

<body>
    <!-- 側邊欄 -->
    <div class="sidebar">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="/PlayCentric/events/listEvents">
                    <i class="fas fa-calendar-alt mr-2"></i>活動管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/PlayCentric/eventSignup/manage">
                    <i class="fas fa-users mr-2"></i>報名管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/PlayCentric/eventVotes/manage">
                    <i class="fas fa-vote-yea mr-2"></i>投票管理
                </a>
            </li>
        </ul>
    </div>

    <!-- 主要內容區域 -->
    <div class="content-wrapper">
        <h1 class="mb-4">投票管理</h1>

        <!-- 新增：統計數據選擇下拉菜單 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <select id="statsSelect" class="form-control" onchange="updateStatistics()">
                    <option value="">所有活動統計</option>
                    <!-- 動態生成活動選項 -->
                </select>
            </div>
        </div>

        <!-- 統計信息區 -->
        <div class="stat-cards-container mb-4">
            <!-- 大統計卡片 -->
            <div class="stat-card-large">
                <h3>總投票數</h3>
                <div class="stat-value" id="totalVotes">載入中...</div>
            </div>
            <!-- 小統計卡片 -->
            <div class="stat-card-small">
                <h3>有效投票</h3>
                <div class="stat-value" id="validVotes">載入中...</div>
            </div>
            <div class="stat-card-small">
                <h3>無效投票</h3>
                <div class="stat-value" id="pendingVotes">載入中...</div>
            </div>
            <div class="stat-card-small">
                <h3>參與人數</h3>
                <div class="stat-value" id="uniqueVoters">載入中...</div>
            </div>
            <div class="stat-card-small">
                <h3 id="averageVotesLabel">平均票數</h3>
                <div class="stat-value" id="averageVotes">載入中...</div>
            </div>
        </div>

        <!-- 活動選擇下拉菜單 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <select id="eventSelect" class="form-control" onchange="updateVoteTrendChartByEvent()">
                    <option value="">選擇活動</option>
                    <!-- 動態生成活動選項 -->
                </select>
            </div>
        </div>

        <!-- 圖表類型選擇按鈕 -->
        <div class="row mb-4">
            <div class="col-md-3">
<div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-primary" id="cumulativeBtn">累計投票</button>
    <button type="button" class="btn btn-outline-primary" id="dailyBtn">每日新增</button>
    <button type="button" class="btn btn-outline-primary" id="movingAverageBtn">票數趨勢</button>
    <button type="button" class="btn btn-outline-primary" id="growthRateBtn">增長率</button>
</div>
            </div>
        </div>

        <!-- 圖表區域 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="chart-container">
                    <canvas id="voteTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 搜索表單 -->
        <form class="search-form mb-3" onsubmit="searchVotes(); return false;">
            <div class="input-group">
                <select class="form-control" id="searchField">
                    <option value="all">全部欄位</option>
                    <option value="memberName">會員名稱</option>
                    <option value="eventName">活動名稱</option>
                    <option value="workTitle">作品名稱</option>
                </select>
                <input type="text" class="form-control" id="searchInput" placeholder="輸入搜尋關鍵字">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="submit">
                        <i class="fas fa-search"></i> 搜尋
                    </button>
                </div>
            </div>
        </form>

        <!-- 投票列表 -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>會員名稱</th>
                        <th>活動名稱</th>
                        <th>作品名稱</th>
                        <th>投票時間</th>
                        <th>狀態</th>
                    </tr>
                </thead>
                <tbody id="voteList">
                    <!-- 投票數據通過 JavaScript 動態填充 -->
                </tbody>
            </table>
        </div>

        <!-- 分頁控件 -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 動態生成分頁按鈕 -->
            </ul>
        </nav>
    </div>

    <!-- 引入必要的 JavaScript 文件 -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script th:src="@{/js/axios.min.js}"></script>

    <!-- 內部 JavaScript 代碼 -->
    <script th:inline="javascript">
// ===== 全域變數 =====
// ===== 全域變數 =====
let currentPage = 1; // 當前頁碼
const itemsPerPage = 10; // 每頁顯示的項目數
let allVotes = []; // 所有投票數據
let originalVotes = []; // 原始投票數據（用於搜索恢復）
let voteTrendChart = null; // 投票趨勢圖表對象
let chartMode = 'cumulative'; // 圖表顯示模式：累計、每日、移動平均或增長率
let totalEvents = 0; // 總活動數
let globalUniqueVoters = 0; // 全局唯一投票者數量

// ===== 頁面初始化 =====
$(document).ready(function () {
    console.log('頁面加載完成，開始初始化');
    initCharts(); // 初始化圖表
    loadEvents(); // 載入活動數據
    loadVotes(); // 載入投票數據

    // 綁定搜索框回車事件
    $('#searchInput').keypress(function (event) {
        if (event.which === 13) {
            event.preventDefault();
            searchVotes();
        }
    });

    // 綁定圖表類型切換按鈕事件
    $('#cumulativeBtn').click(() => { chartMode = 'cumulative'; updateVoteTrendChartByEvent(); });
    $('#dailyBtn').click(() => { chartMode = 'daily'; updateVoteTrendChartByEvent(); });
    $('#movingAverageBtn').click(() => { chartMode = 'movingAverage'; updateVoteTrendChartByEvent(); });
    $('#growthRateBtn').click(() => { chartMode = 'growthRate'; updateVoteTrendChartByEvent(); });

    // 綁定統計數據選擇事件
    $('#statsSelect').change(updateStatistics);
});

// ===== 數據加載函數 =====

// 載入所有投票數據
function loadVotes() {
    axios.get('/PlayCentric/eventVotes/api/all')
        .then(response => {
            console.log('投票數據:', response.data);
            allVotes = response.data;
            originalVotes = [...allVotes];
            displayVotes(currentPage);
            setupPagination();
            // 計算全局唯一投票者數量
            globalUniqueVoters = new Set(allVotes.map(vote => vote.member.memId)).size;
            updateStatistics(); // 更新統計信息
        })
        .catch(error => {
            console.error('載入投票數據失敗:', error);
            doAlert('載入投票數據失敗，請稍後再試。');
        });
}

// 載入所有活動數據
function loadEvents() {
    axios.get('/PlayCentric/events/find')
        .then(response => {
            const events = response.data;
            totalEvents = events.length; // 設置總活動數
            const eventSelect = document.getElementById('eventSelect');
            const statsSelect = document.getElementById('statsSelect');
            eventSelect.innerHTML = '<option value="">選擇活動</option>';
            statsSelect.innerHTML = '<option value="">所有活動統計</option>';
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.eventId;
                option.textContent = event.eventName;
                eventSelect.appendChild(option.cloneNode(true));
                statsSelect.appendChild(option);
            });
            updateStatistics(); // 載入事件後更新統計信息
        })
        .catch(error => {
            console.error('載入活動選項失敗:', error);
            doAlert('載入活動選項失敗，請稍後再試。');
        });
}

// ===== 顯示函數 =====

// 顯示投票列表
function displayVotes(page) {
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageVotes = allVotes.slice(start, end);

    const voteList = $('#voteList');
    voteList.empty();

    pageVotes.forEach(vote => {
        voteList.append(`
            <tr>
                <td>${vote.member.memName}</td>
                <td>${vote.event.eventName}</td>
                <td>${vote.eventSignup.workTitle}</td>
                <td>${new Date(vote.voteTime).toLocaleString()}</td>
                <td>
                    <select class="form-control form-control-sm status-select ${vote.eventVoteStatus === 1 ? 'status-valid' : 'status-pending'}" 
                            onchange="updateVoteStatus(${vote.voteId}, this.value)">
                        <option value="1" ${vote.eventVoteStatus === 1 ? 'selected' : ''}>有效</option>
                        <option value="0" ${vote.eventVoteStatus === 0 ? 'selected' : ''}>無效</option>
                    </select>
                </td>
            </tr>
        `);
    });
}

// ===== 分頁相關函數 =====

// 設置分頁控件
function setupPagination() {
    const totalPages = Math.ceil(allVotes.length / itemsPerPage);
    const pagination = $('#pagination');
    pagination.empty();

    // 添加上一頁按鈕
    pagination.append(`
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1}, event)">上一頁</a>
        </li>
    `);

    // 添加頁碼按鈕
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            pagination.append(`
                <li class="page-item ${currentPage === i ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i}, event)">${i}</a>
                </li>
            `);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
        }
    }

    // 添加下一頁按鈕
    pagination.append(`
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1}, event)">下一頁</a>
        </li>
    `);
}

// 切換頁面
function changePage(page, event) {
    if (event) {
        event.preventDefault();
    }
    const totalPages = Math.ceil(allVotes.length / itemsPerPage);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    displayVotes(currentPage);
    setupPagination();

    // 滾動到投票列表的頂部
    const voteListElement = document.getElementById('voteList');
    if (voteListElement) {
        voteListElement.scrollIntoView({ behavior: 'smooth' });
    }
}

// ===== 搜索相關函數 =====

// 搜索投票
function searchVotes() {
    const searchField = $('#searchField').val();
    const searchInput = $('#searchInput').val().toLowerCase();

    if (searchInput.trim() === '') {
        allVotes = [...originalVotes];
    } else {
        allVotes = originalVotes.filter(vote => {
            if (searchField === 'all') {
                // 在所有欄位中搜索
                return Object.values(vote).some(value =>
                    String(value).toLowerCase().includes(searchInput)
                ) ||
                    vote.member.memName.toLowerCase().includes(searchInput) ||
                    vote.event.eventName.toLowerCase().includes(searchInput) ||
                    vote.eventSignup.workTitle.toLowerCase().includes(searchInput);
            } else {
                // 在特定欄位中搜索
                switch (searchField) {
                    case 'memberName':
                        return vote.member.memName.toLowerCase().includes(searchInput);
                    case 'eventName':
                        return vote.event.eventName.toLowerCase().includes(searchInput);
                    case 'workTitle':
                        return vote.eventSignup.workTitle.toLowerCase().includes(searchInput);
                    default:
                        return false;
                }
            }
        });
    }

    currentPage = 1; // 重置到第一頁
    displayVotes(currentPage);
    setupPagination();
}

// ===== 投票狀態更新函數 =====

// 更新投票狀態
function updateVoteStatus(voteId, newStatus) {
    axios.put(`/PlayCentric/eventVotes/api/${voteId}`, { eventVoteStatus: newStatus })
        .then(response => {
            doAlert('投票狀態更新成功');
            loadVotes(); // 重新加載所有投票
            updateStatistics(); // 更新統計信息
            updateEntryVoteCount(response.data.eventSignup.signupId, response.data.eventVoteStatus);
        })
        .catch(error => {
            console.error('更新投票狀態失敗:', error);
            doAlert('更新投票狀態失敗，請稍後再試');
        });
}

// 更新參賽作品的票數（前端處理）
function updateEntryVoteCount(signupId, voteStatus) {
    const voteCountElement = document.querySelector(`#entry-${signupId} .vote-count`);
    if (voteCountElement) {
        let currentCount = parseInt(voteCountElement.textContent);
        if (voteStatus === 1) {
            currentCount++;
        } else {
            currentCount = Math.max(0, currentCount - 1);
        }
        voteCountElement.textContent = currentCount;
    }
}

// ===== 統計資訊更新函數 =====

// 更新統計信息
function updateStatistics() {
    const selectedEventId = $('#statsSelect').val();
    const url = selectedEventId 
        ? `/PlayCentric/eventVotes/api/statistics/${selectedEventId}`
        : '/PlayCentric/eventVotes/api/statistics';

    axios.get(url)
        .then(response => {
            const stats = response.data;
            updateStatCards(stats, selectedEventId !== '');
        })
        .catch(error => {
            console.error('載入統計資訊失敗:', error);
            doAlert('載入統計資訊失敗，請稍後再試。');
        });
}

// 更新統計卡片
function updateStatCards(stats, isSingleEvent) {
    $('#totalVotes').text(stats.totalVotes);
    $('#validVotes').text(stats.validVotes);
    $('#pendingVotes').text(stats.pendingVotes);
    
    if (isSingleEvent) {
        $('#uniqueVoters').text(stats.uniqueVoters);
        const avgVotes = stats.avgVotesPerUser.toFixed(2);
        $('#averageVotes').text(avgVotes);
        $('#averageVotesLabel').text('平均每人票數');
    } else {
        // 顯示全局唯一投票者數量和總活動數
        $('#uniqueVoters').text(globalUniqueVoters);
        $('#averageVotes').text(totalEvents);
        $('#averageVotesLabel').text('總活動數');
    }
}

// ===== 圖表相關函數 =====

// 初始化圖表
function initCharts() {
    const voteTrendCtx = document.getElementById('voteTrendChart').getContext('2d');
    if (voteTrendChart) {
        voteTrendChart.destroy();
    }
    voteTrendChart = new Chart(voteTrendCtx, {
        type: 'line',
        data: {
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: '活動天數'
                    },
                    ticks: {
                        stepSize: 1
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '投票數'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: '投票趨勢圖'
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            return '第 ' + tooltipItems[0].parsed.x + ' 天';
                        }
                    }
                }
            }
        }
    });
}

// 更新投票趨勢圖表（根據選擇的活動）
function updateVoteTrendChartByEvent() {
    const selectedEventId = document.getElementById('eventSelect').value;
    const selectedEventElement = document.getElementById('eventSelect');
    const selectedEventText = selectedEventElement.options[selectedEventElement.selectedIndex].text;

    if (!selectedEventId || selectedEventText === '選擇活動') {
        if (voteTrendChart) {
            voteTrendChart.data.datasets = [];
            voteTrendChart.update();
        }
        return;
    }

    axios.get(`/PlayCentric/events/get/${selectedEventId}`)
        .then(eventResponse => {
            const event = eventResponse.data;
            const votingStartDate = event.eventSignupDeadLine;
            const votingEndDate = event.eventEndTime;

            axios.get(`/PlayCentric/eventVotes/api/event/${selectedEventId}`)
                .then(votesResponse => {
                    const votes = votesResponse.data;
                    const voteTrend = processVoteTrend(votes, votingStartDate, votingEndDate);
                    updateChart(voteTrend, selectedEventText, votingStartDate, votingEndDate);
                })
                .catch(error => {
                    console.error('載入投票趨勢失敗:', error);
                    doAlert('載入投票趨勢失敗，請稍後再試。');
                });
        })
        .catch(error => {
            console.error('載入活動信息失敗:', error);
            doAlert('載入活動信息失敗，請稍後再試。');
        });
}

// 處理投票趨勢數據
function processVoteTrend(votes, eventStartDate, eventEndDate) {
    const startDate = moment(eventStartDate);
    const endDate = moment(eventEndDate);
    const totalDays = endDate.diff(startDate, 'days') + 1;

    // 初始化所有天數的投票數為0
    const trendMap = Array(totalDays).fill(0);
    
    // 計算每天的投票數
    votes.forEach(vote => {
        const dayDiff = moment(vote.voteTime).diff(startDate, 'days');
        if (dayDiff >= 0 && dayDiff < totalDays) {
            trendMap[dayDiff]++;
        }
    });

    let cumulative = 0;
    const dailyData = [];
    const cumulativeData = [];

    // 生成每日和累計數據
    trendMap.forEach((count, day) => {
        cumulative += count;
        dailyData.push({ x: day, y: count });
        cumulativeData.push({ x: day, y: cumulative });
    });

    // 計算移動平均（不限於7日）
    const movingAverage = calculateMovingAverage(dailyData, Math.min(7, totalDays));

    // 計算增長率
    const growthRate = calculateGrowthRate(dailyData);

    return {
        cumulative: cumulativeData,
        daily: dailyData,
        movingAverage: movingAverage,
        growthRate: growthRate
    };
}

// 計算移動平均
function calculateMovingAverage(data, window) {
    const result = [];
    for (let i = 0; i < data.length; i++) {
        const start = Math.max(0, i - window + 1);
        const end = i + 1;
        const subset = data.slice(start, end);
        const sum = subset.reduce((acc, val) => acc + val.y, 0);
        const avg = sum / subset.length;
        result.push({ x: data[i].x, y: avg });
    }
    return result;
}

// 計算增長率
function calculateGrowthRate(data) {
    const result = [{ x: 0, y: 0 }]; // 第一天增長率為0
    for (let i = 1; i < data.length; i++) {
        const prevValue = data[i - 1].y;
        const currentValue = data[i].y;
        const growthRate = prevValue === 0 ? 0 : ((currentValue - prevValue) / prevValue) * 100;
        result.push({ x: data[i].x, y: growthRate });
    }
    return result;
}

// 更新圖表
function updateChart(voteTrend, eventName, startDate, endDate) {
    let data;
    let yAxisLabel;

    switch(chartMode) {
        case 'cumulative':
            data = voteTrend.cumulative;
            yAxisLabel = '累計投票數';
            break;
        case 'daily':
            data = voteTrend.daily;
            yAxisLabel = '每日投票數';
            break;
        case 'movingAverage':
            data = voteTrend.movingAverage;
            yAxisLabel = '移動平均';
            break;
        case 'growthRate':
            data = voteTrend.growthRate;
            yAxisLabel = '增長率 (%)';
            break;
    }

    const color = getRandomColor();

    voteTrendChart.data.datasets = [{
        label: '活動: ' + eventName,
        data: data,
        borderColor: color,
        backgroundColor: color + '20',
        tension: 0.1,
        fill: true
    }];

    voteTrendChart.options.scales.x.title.text = '活動天數';
    voteTrendChart.options.scales.y.title.text = yAxisLabel;

    // 設置 x 軸的最小值和最大值
    voteTrendChart.options.scales.x.min = 0;
    voteTrendChart.options.scales.x.max = data.length - 1;

    // 設置 y 軸自動縮放
    voteTrendChart.options.scales.y.beginAtZero = true;

    voteTrendChart.options.plugins.title.text = `${eventName} - ${getChartTitle(chartMode)}`;
    voteTrendChart.update();
}

// 獲取圖表標題
function getChartTitle(mode) {
    switch(mode) {
        case 'cumulative':
            return '累計投票趨勢圖';
        case 'daily':
            return '每日新增投票趨勢圖';
        case 'movingAverage':
            return '移動平均趨勢圖';
        case 'growthRate':
            return '投票增長率趨勢圖';
        default:
            return '投票趨勢圖';
    }
}

// 生成隨機顏色
function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}
console.log('投票管理腳本載入完成');

        </script>
</body>

</html>