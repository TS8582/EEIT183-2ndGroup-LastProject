<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${event != null ? event.eventName : '活動詳情'}">活動詳情</title>
    <!-- 引入 Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- 引入 Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <!-- 引入 AOS 動畫庫 -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- 自定義 CSS -->
    <style>
        /* 基本樣式 */
        body {
            background-color: #f4f7f6;
            font-family: 'Noto Sans TC', sans-serif;
            color: #333;
        }

        /* 活動標題區域樣式 */
        .event-header {
            background: linear-gradient(45deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            padding: 4rem 0;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }

        /* 動畫背景 */
        .event-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(45deg, #ffffff11, #ffffff11 10px, #ffffff22 10px, #ffffff22 20px);
            animation: headerAnimation 20s linear infinite;
        }

        @keyframes headerAnimation {
            0% {
                transform: translateX(0) translateY(0);
            }

            100% {
                transform: translateX(-25%) translateY(-25%);
            }
        }

        .event-title {
            font-size: 3.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .event-description {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 1rem auto;
            position: relative;
            z-index: 1;
        }

        /* 卡片樣式 */
        .card {
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
            background-color: #ffffff;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            background-color: #1a2a6c;
            color: white;
            font-weight: bold;
            border-bottom: none;
        }

        .card-footer {
            background-color: transparent;
            border-top: none;
            padding-top: 0;
        }

        /* 參賽作品卡片樣式 */
        .entry-card {
            margin-bottom: 30px;
        }

        .entry-image {
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .entry-card:hover .entry-image {
            transform: scale(1.05);
        }

        .entry-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1a2a6c;
        }

        .entry-description {
            font-size: 0.9rem;
            color: #666;
            height: 3em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* 按鈕樣式 */
        .btn-primary,
        .btn-outline-primary {
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #1a2a6c;
            border-color: #1a2a6c;
            color: white;
        }

        .btn-primary:hover,
        .btn-primary:focus {
            background-color: #0f1d4e;
            border-color: #0f1d4e;
        }

        .btn-outline-primary {
            color: #1a2a6c;
            border-color: #1a2a6c;
        }

        .btn-outline-primary:hover,
        .btn-outline-primary:focus {
            background-color: #1a2a6c;
            color: white;
        }

        /* 報名按鈕特殊樣式 */
        .btn-signup {
            background: linear-gradient(45deg, #fdbb2d, #b21f1f);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(253, 187, 45, 0.3);
        }

        .btn-signup:hover {
            background: linear-gradient(45deg, #b21f1f, #fdbb2d);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(178, 31, 31, 0.4);
        }

        /* 倒計時樣式 */
        #countdown {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            color: #1a2a6c;
        }

        /* 響應式設計調整 */
        @media (max-width: 768px) {
            .event-title {
                font-size: 2.5rem;
            }

            .event-description {
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- 導航欄 -->
    <div class="dnav" th:replace="~{/layout/nav}"></div>

    <!-- 活動詳情內容 -->
    <div th:if="${event != null}" class="fade-in">
        <!-- 活動標題區域 -->
        <div class="event-header text-center">
            <div class="container">
                <h1 class="event-title" data-aos="fade-down" th:text="${event.eventName}">活動名稱</h1>
                <p class="event-description" data-aos="fade-up" data-aos-delay="200"
                    th:text="${event.eventDescription}">活動描述</p>
            </div>
        </div>

        <div class="container">
            <!-- 顯示成功或錯誤消息 -->
            <div th:if="${successMessage}" class="alert alert-success fade-in" role="alert" th:text="${successMessage}">
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger fade-in" role="alert" th:text="${errorMessage}">
            </div>

            <div class="row">
                <!-- 左側：活動詳情 -->
                <div class="col-lg-8">
                    <!-- 活動詳細信息卡片 -->
                    <div class="card mb-4" data-aos="fade-up">
                        <div class="card-header">
                            <h5 class="mb-0">活動詳情</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled">
                                <li><i class="far fa-calendar-alt mr-2"></i> <strong>開始時間：</strong>
                                    <span
                                        th:text="${#temporals.format(event.eventStartTime, 'yyyy年MM月dd日 HH:mm')}"></span>
                                </li>
                                <li><i class="far fa-calendar-check mr-2"></i> <strong>結束時間：</strong>
                                    <span
                                        th:text="${#temporals.format(event.eventEndTime, 'yyyy年MM月dd日 HH:mm')}"></span>
                                </li>
                                <li><i class="far fa-clock mr-2"></i> <strong>報名截止時間：</strong>
                                    <span
                                        th:text="${#temporals.format(event.eventSignupDeadLine, 'yyyy年MM月dd日 HH:mm')}"></span>
                                </li>
                                <li><i class="fas fa-info-circle mr-2"></i> <strong>狀態：</strong>
                                    <span
                                        th:text="${event.eventStatus == 0 ? '未開始' : (event.eventStatus == 1 ? '進行中' : '已結束')}"
                                        th:class="${event.eventStatus == 0 ? 'badge badge-warning' : (event.eventStatus == 1 ? 'badge badge-success' : 'badge badge-secondary')}">
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- 活動規則 -->
                    <div class="card mb-4" data-aos="fade-up" data-aos-delay="200">
                        <div class="card-header">
                            <h5 class="mb-0">活動規則</h5>
                        </div>
                        <div class="card-body">
                            <ol>
                                <li>每位參賽者只能提交一件作品。</li>
                                <li>作品必須是原創，不得抄襲他人作品。</li>
                                <li>每位用戶在本活動中最多可投5票，不能重複投票給同一作品。</li>
                                <li>主辦方保留對活動規則進行解釋和修改的權利。</li>
                            </ol>
                        </div>
                    </div>

                    <!-- 參賽作品區域 -->
                    <h2 class="mb-4">參賽作品</h2>
                    <div id="entries-list" class="row">
                        <!-- 動態加載參賽作品 -->
                    </div>
                </div>

<!-- 右側區域 -->
<div class="col-lg-4">
    <!-- 報名按鈕 -->
    <button id="signupButton" class="btn btn-signup btn-lg btn-block mb-4"
            data-aos="fade-left"
            th:disabled="${event.eventStatus == 2}"
            th:text="${event.eventStatus == 2 ? '活動已結束' : '我要報名'}">
        我要報名
    </button>

                    <!-- 活動倒計時 -->
                    <div class="card mb-4" data-aos="fade-left" data-aos-delay="200">
                        <div class="card-header">
                            <h5 class="mb-0">活動倒計時</h5>
                        </div>
                        <div class="card-body">
                            <p id="countdown" class="mb-0"></p>
                        </div>
                    </div>

                    <!-- 常見問題 -->
                    <div class="card mb-4" data-aos="fade-left" data-aos-delay="400">
                        <div class="card-header">
                            <h5 class="mb-0">常見問題</h5>
                        </div>
                        <div class="card-body">
                            <div id="faqAccordion">
                                <div class="card">
                                    <div class="card-header" id="headingOne">
                                        <h2 class="mb-0">
                                            <button class="btn btn-link" type="button" data-toggle="collapse"
                                                data-target="#collapseOne">
                                                如何參與活動？
                                            </button>
                                        </h2>
                                    </div>
                                    <div id="collapseOne" class="collapse" data-parent="#faqAccordion">
                                        <div class="card-body">
                                            點擊頁面上的"我要報名"按鈕，填寫報名表單並上傳您的作品即可參與活動。
                                        </div>
                                    </div>
                                </div>
                                <!-- 更多FAQ項目可以在這裡添加 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 返回活動列表按鈕 -->
            <a th:href="@{/events/public/list}" class="btn btn-secondary mt-3 mb-5">返回活動列表</a>
        </div>
    </div>

    <!-- 活動不存在時顯示的錯誤信息 -->
    <div th:if="${event == null}" class="container mt-5">
        <div class="alert alert-danger">
            無法找到指定的活動信息。
        </div>
        <a th:href="@{/events/public/list}" class="btn btn-secondary">返回活動列表</a>
    </div>

    <!-- 作品詳情模態框 -->
    <div class="modal fade" id="entryDetailModal" tabindex="-1" role="dialog" aria-labelledby="entryDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="entryDetailModalLabel">作品詳情</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="entryDetailContent">
                    <!-- 作品詳情將在這裡動態填充 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 報名模態框 -->
    <div class="modal fade" id="signupModal" tabindex="-1" role="dialog" aria-labelledby="signupModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="signupModalLabel">活動報名</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 報名表單 -->
                    <form id="signupForm" th:action="@{/eventSignup/create}" method="post"
                        enctype="multipart/form-data">
                        <input type="hidden" name="eventId" th:value="${event.eventId}">
                        <div class="form-group">
                            <label for="workTitle">作品標題</label>
                            <input type="text" class="form-control" id="workTitle" name="workTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="workDescription">作品描述</label>
                            <textarea class="form-control" id="workDescription" name="workDescription" rows="3"
                                required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="photoFile">上傳作品圖片</label>
                            <input type="file" class="form-control-file" id="photoFile" name="photoFile" required>
                        </div>
                        <button type="submit" class="btn btn-primary">提交報名</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入必要的 JavaScript 文件 -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- 引入 AOS 動畫庫 JavaScript -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script th:inline="javascript">
/*<![CDATA[*/
// 定義全局變量
const eventId = /*[[${event.eventId}]]*/ null;
const eventStatus = /*[[${event.eventStatus}]]*/ null;
const userId = /*[[${session.loginMember?.memId}]]*/ null;

/**
 * 載入參賽作品的函數
 */
function loadEntries() {
    $('#entries-list').html('<p class="text-center">載入中，請稍候...</p>');

    $.ajax({
        url: '/PlayCentric/eventSignup/api/event/' + eventId,
        method: 'GET',
        success: function (entries) {
            console.log("接收到的參賽作品:", entries);
            const entriesList = $('#entries-list');
            entriesList.empty();

            if (entries.length === 0) {
                entriesList.append('<p class="col-12">目前還沒有參賽作品。</p>');
            } else {
                entries.forEach(function (entry) {
                    entriesList.append(`
                        <div class="col-md-4 col-lg-3 entry-card mb-4">
                            <div class="card h-100">
                                <img src="/PlayCentric/eventSignup/image/${entry.signupId}" class="card-img-top entry-image" alt="${entry.workTitle}">
                                <div class="card-body">
                                    <h5 class="card-title">${entry.workTitle}</h5>
                                    <p class="card-text">${entry.workDescription.substring(0, 15)}...</p>
                                    <p class="text-muted">目前票數：<span class="vote-count" data-signup-id="${entry.signupId}">${entry.voteCount}</span></p>
                                </div>
                                <div class="card-footer">
                                    <button onclick="showEntryDetail(${entry.signupId})" class="btn btn-outline-primary btn-sm mr-2">查看詳情</button>
                                    <button onclick="vote(${entry.signupId})" class="btn btn-primary btn-sm" ${eventStatus != 1 ? 'disabled' : ''}>
                                    投票
                                    </button>
                                </div>
                            </div>
                        </div>
                    `);
                });
            }
        },
        error: function (xhr, status, error) {
            console.error("載入參賽作品時發生錯誤:", error);
            $('#entries-list').html('<p class="col-12 text-danger">載入參賽作品時發生錯誤，請<a href="javascript:void(0);" onclick="loadEntries()">重試</a>。</p>');
        }
    });
}

/**
 * 顯示作品詳情的函數
 * @param {number} signupId - 報名ID
 */
function showEntryDetail(signupId) {
    $.ajax({
        url: '/PlayCentric/eventSignup/api/' + signupId,
        method: 'GET',
        success: function (entry) {
            const detailContent = `
                <img src="/PlayCentric/eventSignup/image/${entry.signupId}" class="img-fluid mb-3" alt="${entry.workTitle}">
                <h3>${entry.workTitle}</h3>
                <p>${entry.workDescription}</p>
                <p>作者：${entry.member.nickname}</p>
                <p class="text-muted">目前票數：<span class="vote-count" data-signup-id="${entry.signupId}">${entry.voteCount}</span></p>
            `;
            
            $('#entryDetailContent').html(detailContent);
            $('#entryDetailModal').modal('show');

            $(`.vote-count[data-signup-id="${entry.signupId}"]`).text(entry.voteCount);
        },
        error: function (xhr, status, error) {
            console.error("載入作品詳情時發生錯誤:", error);
            alert("載入作品詳情失敗，請稍後再試。");
        }
    });
}

/**
 * 投票函數
 * @param {number} signupId - 報名ID
 */
function vote(signupId) {
    if (!userId) {
        alert("請先登入後再投票");
        return;
    }

    if (eventStatus == 2) {
        alert("活動已結束，無法投票");
        return;
    }

    $.ajax({
        url: '/PlayCentric/eventVotes/api/create',
        method: 'POST',
        data: { memberId: userId, signupId: signupId },
        success: function (response) {
            if (response.success) {
                alert("投票成功！");
                $(`.vote-count[data-signup-id="${signupId}"]`).text(response.updatedVoteCount);
            } else {
                alert(response.message || "投票失敗，請稍後再試。");
            }
        },
        error: function (xhr, status, error) {
            console.error("投票錯誤詳情:", xhr.responseJSON);
            let errorMessage = "投票時發生錯誤，請稍後再試。";
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            }
            alert(errorMessage);
        }
    });
}

/**
 * 更新倒計時的函數
 */
function updateCountdown() {
    const now = new Date().getTime();
    const endTime = new Date(/*[[${event.eventEndTime}]]*/).getTime();
    const timeLeft = endTime - now;

    if (timeLeft > 0) {
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        document.getElementById("countdown").innerHTML = `${days}天 ${hours}時 ${minutes}分 ${seconds}秒`;
    } else {
        document.getElementById("countdown").innerHTML = "活動已結束";
        $('#signupButton').prop('disabled', true).text('活動已結束');
    }
}

/**
 * 更新活動狀態的函數
 * @param {Object} event - 活動對象
 */
function updateEventStatus(event) {
    if (event.eventStatus === 1 && new Date(event.eventEndTime) < new Date()) {
        event.eventStatus = 2; // 更新狀態為已結束
        $('#eventStatus').text('已結束').removeClass('badge-success').addClass('badge-secondary');
        $('#signupButton').prop('disabled', true).text('活動已結束');
    }
}

// 頁面加載完成後執行的函數
$(document).ready(function () {
    // 初始化 AOS 動畫
    AOS.init({
        duration: 1000,
        once: true
    });
    
    // 獲取活動數據並更新狀態
    const event = /*[[${event}]]*/ null;
    if (event) {
        updateEventStatus(event);
    }

    // 載入參賽作品
    loadEntries();

    // 綁定報名按鈕點擊事件
    $('#signupButton').click(function () {
        if (eventStatus == 2) {
            alert("活動已結束，無法報名");
            return;
        }
        $('#signupModal').modal('show');
    });

    // 綁定報名表單提交事件
    $('#signupForm').submit(function (e) {
        e.preventDefault();
        if (eventStatus == 2) {
            alert("活動已結束，無法報名");
            return;
        }
        let formData = new FormData(this);
        $.ajax({
            url: $(this).attr('action'),
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert('報名成功！');
                $('#signupModal').modal('hide');
                loadEntries(); // 重新加載作品列表
            },
            error: function (xhr, status, error) {
                alert('報名失敗，請稍後再試。');
            }
        });
    });

    // 修正模態框關閉問題
    $('.modal').on('hidden.bs.modal', function () {
        $(this).find('form').trigger('reset');
    });

    // 確保模態框可以正確關閉
    $('.close').click(function () {
        $(this).closest('.modal').modal('hide');
    });

    // 啟動倒計時
    setInterval(updateCountdown, 1000);

    // 初始檢查活動狀態
    if (eventStatus == 2) {
        $('#signupButton').prop('disabled', true).text('活動已結束');
    }
});
/*]]>*/
</script>
</body>

</html>