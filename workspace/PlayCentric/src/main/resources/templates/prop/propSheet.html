<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>遊戲道具交易後台</title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/dataTables.dataTables.css}" />
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.js}"></script>
    <script th:src="@{/js/dataTables.js}"></script>
    <script th:src="@{/js/axios.min.js}"></script>
  </head>
  <body>
    <header class="container">
      <h1>遊戲道具交易後台</h1>
      <div id="gameList">
        <form id="myForm">
          <label for="SelectGame">遊戲選單:</label>
          <select id="SelectGame" name="gameId"></select>
          <button id="submitBtn">送出</button>
        </form>
        <div th:replace="~{prop/marketNavbar}"></div>
      </div>
    </header>
    <div class="container">
      <table id="myTable" class="display">
        <thead>
          <tr>
            <th>ID</th>
            <th>名稱</th>
            <th>圖片</th>
            <th>種類</th>
            <th>稀有度</th>
            <th>描述</th>
            <th>創建時間</th>
            <th>更新時間</th>
            <th>修改</th>
            <th>刪除</th>
          </tr>
        </thead>
        <tbody>
          <!-- 這裡的行會動態生成 -->
        </tbody>
      </table>
    </div>

    <!-- 找所有遊戲並加入選單 -->
    <script>
      $(document).ready(function () {
        axios
          .get("http://localhost:8080/PlayCentric/prop/findAllGame")
          .then(function (res) {
            const games = res.data;
            const selectGame = document.getElementById("SelectGame");
            games.forEach(function (game) {
              const option = document.createElement("option");
              option.value = game.gameId;
              option.text = game.gameName;
              selectGame.appendChild(option);
            });
          })
          .catch(function (error) {
            console.error("Error fetching game data:", error);
          });

        var table = $("#myTable").DataTable();

        // 根據gameId找尋所有props方法
        function findAllPropsByGameId(gameId) {
          axios
            .get(
              "http://localhost:8080/PlayCentric/prop/findAllPropsByGameId",
              {
                params: {
                  gameId: gameId,
                },
              }
            )
            .then((res) => {
              const props = res.data;
              table.clear(); // 清空現有的行
              props.forEach(function (prop) {
                const row = [
                  prop.propId,
                  prop.propName,
                  `<img src="${prop.propImageId}" alt="${prop.propName}" width="50">`,
                  prop.propType ? prop.propType.propType : "",
                  prop.propRarity,
                  prop.propDescription,
                  prop.createdTime,
                  prop.updatedTime,
                  '<button class="btn btn-primary">修改</button>',
                  '<button class="btn btn-danger">刪除</button>',
                ];
                table.row.add(row);
              });
              table.draw(); // 重新绘制表格
            })
            .catch((error) => {
              console.error("Error fetching props data:", error);
            });
        }

        // 監聽搜尋遊戲按鈕並執行findAllPropsByGameId()
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.addEventListener("click", (event) => {
          event.preventDefault(); // 取消 form 預設的送出
          const selectedGameId = document.getElementById("SelectGame").value;
          console.log("Selected Game ID:", selectedGameId);
          findAllPropsByGameId(selectedGameId);
        });
      });
    </script>
  </body>
</html>
