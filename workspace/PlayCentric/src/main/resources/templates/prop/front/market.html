<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
  <title>é“å…·äº¤æ˜“å‰å° - å¸‚å ´</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="keywords" content="ecommerce, pet, shop" />
  <meta name="description" content="Free eCommerce Pet Shop HTML Website Template" />

  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/Swiper/9.4.1/swiper-bundle.min.css" />
  <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0-alpha3/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous" />
  <link rel="stylesheet" type="text/css" th:href="@{/css/prop/template/vendor.css}" />
  <link rel="stylesheet" type="text/css" th:href="@{/css/prop/template/style.css}" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Chilanka&family=Montserrat:wght@300;400;500&display=swap"
    rel="stylesheet" />
  <style>
    header,
    .container {
      font-family: "Franklin Gothic Medium", "Arial Narrow", Arial, sans-serif;
    }

    .selected {
      border: 3px solid gold;
    }

    .quantity {
      background-color: grey;
      color: white;
      text-align: center;
      margin-top: 5px;
    }
  </style>
</head>

<body>

  <div th:replace="~{prop/propNavbar}"></div>
  <div id="memberId" class="d-none" th:if="${session.loginMember}" th:text="${session.loginMember.memId}"></div>

  <header class="mt-5 d-flex justify-content-center">
    <div id="gameList" class="bg-light text-dark p-4 rounded shadow-sm">
      <form id="myForm" class="d-flex mb-3 align-items-center">
        <select class="form-select me-2" id="SelectGame" name="gameId"
          style="font-size: 2rem; border: 2px solid #343a40"></select>
        <button id="submitBtn" class="btn btn-dark" style="font-size: 1.5rem">
          ğŸ•¹ï¸
        </button>
      </form>
      <input type="text" id="searchInput" class="form-control" placeholder="åœ¨æ‹è³£å ´ä¸­æœå°‹"
        style="font-size: 1.5rem; border: 2px solid #343a40" />
    </div>
  </header>
  <div class="container mt-5" style="
        font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
      ">
    <div class="section-header d-md-flex justify-content-between align-items-center">
      <div class="mb-4 mb-md-0 d-flex justify-content-center w-100">
        <p class="m-0">
          <!-- è‡ªå‹•æ–°å¢æŒ‰éˆ• -->
        </p>
        <div class="m-3">
          <a href="#" id="inventoryBtn" class="btn btn-dark btn-lg" data-bs-toggle="modal" data-bs-target="#inventory"
            style="font-weight: 700; padding: 0rem 2rem">
            è²©å”®
          </a>
        </div>
      </div>

      <!-- å€‰åº«Modal -->
      <div class="modal fade" id="inventory" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header" style="background-color: rgb(0, 5, 70); color: white">
              <h5 class="modal-title" id="exampleModalLabel" style="
                    font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial,
                      sans-serif;
                    font-weight: bolder;
                  ">
                å¾æ‚¨çš„ç‰©å“æ¸…å–®é¸æ“‡ä¸€é …ç‰©å“
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-8" id="inventoryPropsContainer">
                  <!-- é“å…·åœ–ç‰‡æœƒåœ¨é€™è£¡ç”Ÿæˆ -->
                </div>
                <div class="col-4">
                  å®Œæ•´å•†å“è³‡è¨Š
                </div>
              </div>
            </div>
            <div class="modal-footer">

              <button type="button" class="btn btn-dark">ğŸ’°</button>
              <button type="button" class="btn btn-dark" data-bs-dismiss="modal">
                âŒ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row isotope-container justify-content-center">
    <!-- å•†å“é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
  </div>

  <script th:src="@{/js/prop/template/jquery-1.11.0.min.js}"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/Swiper/9.4.1/swiper-bundle.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0-alpha3/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>
  <script th:src="@{/js/prop/template/plugins.js}"></script>
  <script th:src="@{/js/prop/template/script.js}"></script>
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <script th:src="@{/js/axios.min.js}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js"></script>
  <!-- Isotopeåº“ -->

  <script>
    // åŠ è¼‰æ‰€æœ‰éŠæˆ²
    const propTypesMap = {};
    const inventoryBtn = document.getElementById('inventoryBtn');
    let memId = document.getElementById('memberId')?.textContent.trim() || null;
    let selectedGameId;
    let inventoryProps; //å€‰åº«è£¡çš„æ‰€æœ‰é“å…·

    $(document).ready(function () {
      loadGames();

      // æäº¤æŒ‰éˆ•é»æ“Šäº‹ä»¶
      $("#submitBtn").click(function (event) {
        event.preventDefault(); // å–æ¶ˆè¡¨å–®çš„é»˜èªæäº¤è¡Œç‚º
        selectedGameId = $("#SelectGame").val(); // ç²å–é¸ä¸­çš„éŠæˆ²ID
        fetchPropTypesByGameId(selectedGameId, function (propTypes) {
          propTypes.forEach(function (propType) {
            propTypesMap[propType.propTypeId] = propType.propType; // å¡«å…… propTypesMap
          });
          generateFilterButtons(propTypes); // ç”Ÿæˆç¯©é¸æŒ‰éˆ•
          findAllPropsByGameId(selectedGameId); // æŸ¥æ‰¾æ‰€æœ‰é“å…·
        });
      });

      // åˆå§‹åŒ– Isotope
      const $container = $(".isotope-container").isotope({
        itemSelector: ".item",
        layoutMode: "fitRows",
      });

      // ç¯©é¸æŒ‰éˆ•é»æ“Šäº‹ä»¶
      $(document).on("click", ".filter-button", function () {
        const filterValue = $(this).attr("data-filter");
        $container.isotope({ filter: filterValue });
        $(".filter-button").removeClass("active");
        $(this).addClass("active");

        // é‡æ–°è§¸ç™¼æœç´¢æ¢ä»¶
        $("#searchInput").trigger("input");
      });

      // æœå°‹è¼¸å…¥æ¡†äº‹ä»¶
      $("#searchInput").on("input", function () {
        const searchValue = $(this).val().toLowerCase();
        const activeTypeFilter = $(".filter-button.active").attr(
          "data-filter"
        );

        $container.isotope({
          filter: function () {
            const name = $(this).find(".card-title").text().toLowerCase();
            const typeClass = $(this)
              .attr("class")
              .split(" ")
              .filter((cls) =>
                cls.startsWith(activeTypeFilter.replace(".", ""))
              );

            return (
              name.includes(searchValue) &&
              (activeTypeFilter === "*" || typeClass.length > 0)
            );
          },
        });
      });
    });

    function loadGames() {
      axios
        .get("http://localhost:8080/PlayCentric/prop/findAllGame")
        .then(function (res) {
          const games = res.data;
          const selectGame = $("#SelectGame");
          console.log("Games data:", games); // æ‰“å°æ•¸æ“šå…§å®¹

          selectGame.empty();
          games.forEach(function (game) {
            const option = $("<option></option>")
              .val(game.gameId)
              .text(game.gameName);
            selectGame.append(option);
          });

          if (games.length > 0) {
            selectGame.val(games[0].gameId);
            $("#submitBtn").click();
          }
        })
        .catch(function (error) {
          console.error("ç²å–éŠæˆ²æ•¸æ“šæ™‚å‡ºéŒ¯:", error);
        });
    }

    // æ ¹æ“š gameId ç²å–æ‰€æœ‰é“å…·ç¨®é¡
    function fetchPropTypesByGameId(gameId, callback) {
      axios
        .get(
          "http://localhost:8080/PlayCentric/prop/findAllPropTypesByGameId",
          {
            params: { gameId: gameId },
          }
        )
        .then((res) => {
          callback(res.data);
          const propTypes = res.data;
          propTypes.forEach(function (propType) {
            propTypesMap[propType.propTypeId] = propType.propType;
            console.log(
              `propTypeId: ${propType.propTypeId}, propType: ${propType.propType}`
            );
          });
        })
        .catch((error) => {
          console.error("ç²å–é“å…·ç¨®é¡æ•¸æ“šæ™‚å‡ºéŒ¯:", error);
        });
    }

    // æ ¹æ“š gameId æŸ¥æ‰¾æ‰€æœ‰é“å…·
    function findAllPropsByGameId(gameId) {
      axios
        .get("http://localhost:8080/PlayCentric/prop/findAllPropsByGameId", {
          params: { gameId: gameId },
        })
        .then((res) => {
          const props = res.data;
          generatePropItems(props); // å‹•æ…‹ç”Ÿæˆé“å…·é …ç›®
          console.log(props);
        })
        .catch((error) => {
          console.error("ç²å–é“å…·æ•¸æ“šæ™‚å‡ºéŒ¯:", error);
        });
    }

    // ç”Ÿæˆç¯©é¸æŒ‰éˆ•
    function generateFilterButtons(propTypes) {
      const filterButtonsContainer = $(".m-0");
      filterButtonsContainer.empty();
      const allButton = $(
        '<button class="filter-button me-4 active" data-filter="*" style="font-size: 2rem;">ALL</button>'
      );
      filterButtonsContainer.append(allButton);
      propTypes.forEach(function (propType) {
        const button = $(
          '<button class="filter-button me-4" style="font-size: 2rem;"></button>'
        )
          .attr("data-filter", `.${propType.propTypeId}`)
          .text(propType.propType);
        console.log(propType.propType);
        filterButtonsContainer.append(button);
      });
    }

    // æ ¹æ“šmemId(JAVA)è·Ÿ gameId(JS) æ‰¾å°‹å€‰åº«é“å…·
    inventoryBtn.addEventListener('click', function () {
      generateInventoryItems(memId, selectedGameId);
    })

    function generateInventoryItems(memId, selectedGameId) {
      axios({
        method: 'get',
        url: 'http://localhost:8080/PlayCentric/prop/memberPropsbyMemId',
        params: { memId: memId }
      })
        .then((res) => {
          const inventory = res.data.filter(item => item.prop.gameId == selectedGameId);
          generateInventoryPropImages(inventory); // èª¿ç”¨ç”Ÿæˆå€‰åº«é“å…·åœ–ç‰‡çš„å‡½æ•¸

        })
        .catch((error) => {
          console.error('ç²å–å€‰åº«è³‡è¨Šæ™‚å‡ºéŒ¯:', error);
        });
    }

    // ç”Ÿæˆå€‰åº«é“å…·åœ–ç‰‡
    function generateInventoryPropImages(inventoryProps) {
      const container = document.getElementById('inventoryPropsContainer');
      container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨

      let rowDiv = null;

      inventoryProps.forEach((item, index) => { // é€™è£¡éœ€è¦æ”¹ç‚ºitemä¾†åŒ…å«propå’ŒpropQuantity
        if (index % 6 === 0) { // æ¯6å€‹é“å…·ç”Ÿæˆä¸€å€‹æ–°çš„row
          rowDiv = document.createElement('div');
          rowDiv.className = 'row mb-3';
          container.appendChild(rowDiv);
        }

        const colDiv = document.createElement('div');
        colDiv.className = 'col-3 mb-3'; // æ¯å€‹åœ–ç‰‡å 3åˆ—ï¼Œä¸¦ä¸”æœ‰åº•éƒ¨å¤–é‚Šè·

        const img = document.createElement('img');
        img.src = `http://localhost:8080/PlayCentric/prop/image?id=${item.prop.propImageId}`;
        img.alt = item.prop.propName;
        img.className = 'img-fluid';
        img.style.width = '6vw';

        // æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½å™¨
        img.addEventListener('click', function () {
          // å…ˆç§»é™¤å…¶ä»–åœ–ç‰‡çš„é¸ä¸­æ¨£å¼
          const allImages = container.getElementsByTagName('img');
          for (let i = 0; i < allImages.length; i++) {
            allImages[i].classList.remove('selected');
          }
          // ç‚ºç•¶å‰é»æ“Šçš„åœ–ç‰‡æ·»åŠ é¸ä¸­æ¨£å¼
          img.classList.add('selected');
        });

        const quantityDiv = document.createElement('div');
        quantityDiv.textContent = `æ•¸é‡: ${item.propQuantity}`; // ä½¿ç”¨æ­£ç¢ºçš„è®Šé‡å
        quantityDiv.className = 'quantity';

        colDiv.appendChild(img);
        colDiv.appendChild(quantityDiv); // å°‡æ•¸é‡ div æ·»åŠ åˆ° colDiv ä¸­
        rowDiv.appendChild(colDiv);
      });
    }

    // ç”Ÿæˆé“å…·é …ç›®
    function generatePropItems(props) {
      const propsContainer = $(".isotope-container");
      propsContainer.empty();
      props.forEach(function (prop) {
        const itemClassId = prop.propTypeId ? prop.propTypeId : "unknown";
        console.log(`Item classId is: ${itemClassId}`);
        const item = $(`
  <div class="item ${itemClassId}" style="margin-bottom:28rem; width:12vw; position: relative;">
    <a href="#" class="card" style="text-decoration: none; color: inherit;">
      <div style="position: relative;">
        <img src="http://localhost:8080/PlayCentric/prop/image?id=${prop.propImageId}" class="img-fluid rounded-4" alt="${prop.propName}" style="width: 11vw;">
      </div>
      <div class="card-body p-0">
        <div class="card-text">
          <h3 class="card-title pt-0 m-0">${prop.propName}</h3>
          <h3 class="secondary-font text-primary">å¹³å‡NT$:${prop.propPrice}</h3>
          <div class="d-flex flex-wrap mt-3">
            <!-- Additional content here -->
          </div>
        </div>
      </div>
    </a>
  </div>
`);

        propsContainer.append(item);
      });

      // æ›´æ–° Isotope å¸ƒå±€
      $(".isotope-container")
        .isotope("reloadItems")
        .isotope({ sortBy: "original-order" });
    }

  </script>
</body>

</html>