<!DOCTYPE html>
<html lang="zh-Hant-TW" xmlns:th="http://www.thymeleaf.org/">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <div class="" th:replace="~{/layout/nav}"></div>
    <link rel="stylesheet" th:href="@{/css/output.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            background-image: url('/PlayCentric/images/bg1.jpg');
        }
    </style>
    <title>PlayCentric-遊戲商店</title>
</head>

<body class="h-screen bg-gray-500">
    <div class="spin hidden">
        <div class="flex justify-center items-center h-4/5 w-full fixed ">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 shadow-md border-lime-500"></div>
        </div>
    </div>
    <div class="flex flex-col h-auto container mx-auto">
        <!-- 篩選欄 -->
        <div class="flex justify-center h-auto my-2 text-white">



            <div class="w-full lg:w-1/2 h-auto border-2 flex flex-col rounded-md justify-center items-center">
                <!-- 以價格篩選 -->
                <div class="flex flex-col items-center justify-center p-2 w-full">
                    <span>依名稱搜尋</span>
                    <input type="text" id="gameName" placeholder="請輸入名稱" class="text-input w-1/3 text-black">
                    <span class="block text-lg">依價格篩選</span>
                    <label for="minPrice">最低價格： </label>
                    <input type="number" placeholder="最低價格" name="minPrice" id="minPrice"
                        class="text-input w-1/3 text-black" maxlength="5">
                    <label for="maxPrice">最高價格： </label>
                    <input type="number" name="maxPrice" id="maxPrice" class="text-input w-1/3 text-black"
                        placeholder="最高價格" maxlength="5">
                </div>
                <!-- 以分類篩選 -->
                <span class="block text-lg">依分類篩選</span>
                <!-- 取所有分類 -->
                <div class="p-2 flex flex-wrap">
                    <th:block th:each="type:${allType}">
                        <div class="text-sm mybtn-tag">
                            <span th:text="${type.gameTypeName}"></span>
                            <input class="hidden" type="checkbox" name="typeId" th:value="${type.gameTypeId}">
                        </div>
                    </th:block>
                </div>
            </div>
        </div>

        <main class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 h-full container mt-2">
            <input id="pages" type="hidden" th:value="${games.totalPages}">
            <th:block th:each="game:${games.content}">

                <div
                    class="h-auto shadow-md border-2 rounded-lg flex flex-col p-2 bg-white border-sky-300 shadow-sky-500">
                    <div class="py-2 h-64 flex justify-center rounded-md">
                        <img th:if="${!game.imageLibs.empty}" class="w-auto h-full rounded-md"
                            th:src="@{/imagesLib/image{id}(id=${game.ImageLibs[0].imageId})}" alt="">
                    </div>
                    <div class="h-1/3 flex text-black flex-col items-center p-2">
                        <div class="flex justify-center">
                            <span class="text-xl p-2 rounded-md select-none" th:text="${game.gameName}"></span>
                        </div>
                        <div class="flex justify-center my-2 space-x-3">
                            <span th:if="${game.rate}" class="price-tag font-semibold"
                                th:text="'-' + ${100 -  game.rate} + '%'"></span>
                            <!-- 沒優惠顯示的價格 -->
                            <span th:if="${game.rate == null}" class="price-tag text-black font-semibold"
                                th:text=" '$' + ${game.price}"></span>
                            <!-- 有優惠顯示的價格 -->
                            <span th:if="${game.rate}" class="price-tag font-semibold"
                                th:text=" '$' + ${game.price * game.rate / 100}"></span>
                        </div>
                        <div class="flex justify-center">
                            <span class="border border-red-300 mybtn mybtn-green">加入購物車</span>
                        </div>
                    </div>
                </div>
            </th:block>


        </main>

    </div>

    <script th:src="@{/js/axios.min.js}"></script>
    <script>
        let pgnum = 0;
        let totalPages = document.querySelector('#pages').value;
        const minPrice = document.querySelector('#minPrice');
        const maxPrice = document.querySelector('#maxPrice');
        let typeId = [];
        const main = document.querySelector('main');
        const spin = document.querySelector('.spin');
        const typeselector = document.querySelectorAll('input[name="typeId"]');
        let scrolltrigger = true;

        // 滑到底部載入事件
        window.addEventListener('scroll', function () {
            var windowHeight = window.innerHeight;
            var documentHeight = document.documentElement.scrollHeight;
            var scrollTop = window.scrollY || window.pageYOffset || document.body.scrollTop + (document.documentElement && document.documentElement.scrollTop || 0);

            if (windowHeight + scrollTop >= documentHeight && scrolltrigger) {
                if (typeId.length === 0 && minPrice.value === '' && maxPrice.value === '') {
                    nofilterplus();
                } else if (typeId.length !== 0 && minPrice.value === '' && maxPrice.value === '') {
                    typefilterplus();
                } else if (minPrice.value !== '' && maxPrice.value !== '' && typeId.length === 0) {
                    pricefilterplus();
                } else if (minPrice.value !== '' && maxPrice.value !== '' && typeId.length !== 0) {
                    typeAndPriceFilterPlus();
                }
            }
        });

        typeselector.forEach(typecheck => {
            typecheck.addEventListener('change', e => {
                typeId = Array.from(typeselector)
                    .filter(input => input.checked)
                    .map(input => parseInt(input.value));
                pgnum = 0; // 重置 pgnum 變數
                main.innerHTML = ''; // 清空主要內容區域
                if (typeId.length > 0 && minPrice.value === '' && maxPrice.value === '') {
                    typefilter(typeId);
                }
                else if (typeId.length > 0 && minPrice.value !== '' && maxPrice.value !== '') {
                    typeAndPriceFilter();
                }
                else if (minPrice.value !== '' && maxPrice.value !== '' && typeId.length === 0) {
                    pricefilter();
                }
                else {
                    nofilter();
                }
            });
        });

        function typefilter(typeIds) {
            pgnum = 0;
            spin.classList.remove('hidden');
            axios.get('/PlayCentric/game/getGamePageByType', {
                params: {
                    pg: pgnum,
                    typeId: typeIds
                },
                paramsSerializer: function (params) {
                    return Object.keys(params).map(key => {
                        if (Array.isArray(params[key])) {
                            return params[key].map(val => `${key}=${val}`).join('&');
                        }
                        return `${key}=${params[key]}`;
                    }).join('&');
                }
            })
                .then(response => {
                    main.innerHTML = ''; // 清空主要內容區域
                    if (response.data.totalPages > 0) {
                        response.data.content.forEach(game => {
                            htmlmaker(game);
                        });
                        totalPages = response.data.totalPages;
                    }
                    spin.classList.add('hidden');
                })
                .catch(error => {
                    spin.classList.add('hidden');
                    console.error('Error fetching data:', error);
                });
        }

        function typefilterplus() {
            spin.classList.remove('hidden');
            scrolltrigger = false;
            if (pgnum < totalPages - 1) {
                axios.get('/PlayCentric/game/getGamePageByType', {
                    params: {
                        pg: pgnum + 1,
                        typeId: typeId
                    },
                    paramsSerializer: function (params) {
                        return Object.keys(params).map(key => {
                            if (Array.isArray(params[key])) {
                                return params[key].map(val => `${key}=${val}`).join('&');
                            }
                            return `${key}=${params[key]}`;
                        }).join('&');
                    }
                })
                    .then(res => {
                        res.data.content.forEach(elm => htmlmaker(elm));
                        pgnum += 1;
                        scrolltrigger = true;
                        spin.classList.add('hidden');
                    })
                    .catch(err => {
                        spin.classList.add('hidden');
                        scrolltrigger = true;
                        console.error(err);
                    });
            } else {
                spin.classList.add('hidden');
            }
        }

        function pricefilter(minPrice, maxPrice) {
            pgnum = 0;
            spin.classList.remove('hidden');
            axios.get('/PlayCentric/game/getGamePageByPrice', {
                params: {
                    pg: pgnum,
                    minPrice: minPrice,
                    maxPrice: maxPrice
                }
            })
                .then(response => {
                    main.innerHTML = ''; // 清空主要內容區域
                    if (response.data.totalPages > 0) {
                        response.data.content.forEach(game => {
                            htmlmaker(game);
                        });
                        totalPages = response.data.totalPages;
                    }
                    spin.classList.add('hidden');
                })
                .catch(error => {
                    spin.classList.add('hidden');
                    console.error('Error fetching data:', error);
                });
        }

        function pricefilterplus() {
            spin.classList.remove('hidden');
            scrolltrigger = false;
            if (pgnum < totalPages - 1) {
                axios.get('/PlayCentric/game/getGamePageByPrice', {
                    params: {
                        pg: pgnum + 1,
                        minPrice: minPrice.value,
                        maxPrice: maxPrice.value
                    }
                })
                    .then(res => {
                        res.data.content.forEach(elm => htmlmaker(elm));
                        pgnum += 1;
                        scrolltrigger = true;
                        spin.classList.add('hidden');
                    })
                    .catch(err => {
                        spin.classList.add('hidden');
                        scrolltrigger = true;
                        console.error(err);
                    });
            } else {
                spin.classList.add('hidden');
            }
        }

        function typeAndPriceFilter() {
            pgnum = 0;
            spin.classList.remove('hidden');
            if (pgnum < totalPages - 1) {
                axios.get('/PlayCentric/game/getGamePageByPriceAndType', {
                    params: {
                        pg: pgnum,
                        typeId: typeId,
                        minPrice: minPrice.value,
                        maxPrice: maxPrice.value
                    },
                    paramsSerializer: function (params) {
                        return Object.keys(params).map(key => {
                            if (Array.isArray(params[key])) {
                                return params[key].map(val => `${key}=${val}`).join('&');
                            }
                            return `${key}=${params[key]}`;
                        }).join('&');
                    }
                })
                    .then(res => {
                        main.innerHTML = '';
                        res.data.content.forEach(elm => htmlmaker(elm));
                        spin.classList.add('hidden');
                    })
                    .catch(err => {
                        spin.classList.add('hidden');
                        console.error(err);
                    });
            } else {
                spin.classList.add('hidden');
            }
        }

        function typeAndPriceFilterPlus() {
            spin.classList.remove('hidden');
            scrolltrigger = false;
            if (pgnum < totalPages - 1) {
                axios.get('/PlayCentric/game/getGamePageByPriceAndType', {
                    params: {
                        pg: pgnum + 1,
                        typeId: typeId,
                        minPrice: minPrice.value,
                        maxPrice: maxPrice.value
                    },
                    paramsSerializer: function (params) {
                        return Object.keys(params).map(key => {
                            if (Array.isArray(params[key])) {
                                return params[key].map(val => `${key}=${val}`).join('&');
                            }
                            return `${key}=${params[key]}`;
                        }).join('&');
                    }
                })
                    .then(res => {
                        res.data.content.forEach(elm => htmlmaker(elm));
                        pgnum += 1;
                        scrolltrigger = true;
                        spin.classList.add('hidden');
                    })
                    .catch(err => {
                        spin.classList.add('hidden');
                        scrolltrigger = true;
                        console.error(err);
                    });
            } else {
                spin.classList.add('hidden');
            }
        }

        minPrice.addEventListener('input', handlePriceFilter);
        maxPrice.addEventListener('input', handlePriceFilter);

        function handlePriceFilter() {
            if (minPrice.value !== '' && maxPrice.value !== '') {
                pgnum = 0;
                if (typeId.length > 0) {
                    typeAndPriceFilter();
                } else {
                    pricefilter(minPrice.value, maxPrice.value);
                }
            }
            if (minPrice.value === '' && maxPrice.value === '') {
                if (typeId.length > 0) {
                    pgnum = 0;
                    typefilter(typeId);
                }
            }
            else {
                nofilter();
            }
        }

        function nofilter() {
            if (minPrice.value === '' && maxPrice.value === '' && typeId.length === 0) {
                pgnum = 0;
                main.innerHTML = ''; // 清空主要內容區域
                spin.classList.remove('hidden');
                axios.get('/PlayCentric/game/getGamePage', { params: { pg: pgnum } })
                    .then(res => {
                        totalPages = res.data.totalPages;
                        res.data.content.forEach(elm => htmlmaker(elm));
                        scrolltrigger = true;
                        spin.classList.add('hidden');
                    })
                    .catch(err => {
                        spin.classList.add('hidden');
                        console.error(err);
                        scrolltrigger = true;
                    });
            }
        }

        function nofilterplus() {
            spin.classList.remove('hidden');
            scrolltrigger = false;
            if (pgnum < totalPages - 1) {
                axios.get('/PlayCentric/game/getGamePage', { params: { pg: pgnum + 1 } })
                    .then(res => {
                        totalPages = res.data.totalPages;
                        res.data.content.forEach(elm => htmlmaker(elm));
                        pgnum += 1;
                        scrolltrigger = true;
                        spin.classList.add('hidden');
                    })
                    .catch(err => {
                        spin.classList.add('hidden');
                        scrolltrigger = true;
                        console.error(err);
                    });
            } else {
                spin.classList.add('hidden');
            }
        }

        function htmlmaker(game) {
            let html = `<div class="h-auto shadow-md border-2 rounded-lg flex flex-col p-2 bg-white border-sky-300 shadow-sky-500">
<div class="py-2 h-64 flex justify-center rounded-md">`;
            if (game.imageLibs.length > 0) {
                html += `<img class="w-auto h-full rounded-md" src="/PlayCentric/imagesLib/image${game.imageLibs[0].imageId}" alt="">`;
            }
            html += `</div>
<div class="h-1/3 flex text-black flex-col items-center p-2">
    <div class="flex justify-center">
        <span class="text-xl p-2 rounded-md select-none">${game.gameName}</span>
    </div>
    <div class="flex justify-center my-2 space-x-3">`;
            if (game.rate != null) {
                html += `<span class="price-tag font-semibold">-${100 - game.rate}%</span>
<span class="price-tag font-semibold">NT$${Math.round(game.price * game.rate / 100)}</span>`;
            } else {
                html += `<span class="price-tag text-black font-semibold">NT$${game.price}</span>`;
            }
            html += `</div>
    <div class="flex justify-center">
        <span class="border border-red-300 mybtn mybtn-green">加入購物車</span>
    </div>
</div>
</div>`;
            main.innerHTML += html;
        }

        const typeTag = document.querySelectorAll('.mybtn-tag');
        typeTag.forEach(tag => {
            tag.addEventListener('click', e => {
                const checkbox = tag.querySelector('input');
                if (tag.classList.contains('mybtn-tag')) {
                    tag.classList.remove('mybtn-tag');
                    tag.classList.add('tag-selected');
                    checkbox.checked = true;
                    typeId.push(parseInt(checkbox.value));
                } else {
                    tag.classList.add('mybtn-tag');
                    tag.classList.remove('tag-selected');
                    checkbox.checked = false;
                    typeId = typeId.filter(item => item !== parseInt(checkbox.value));
                }
                checkbox.dispatchEvent(new Event('change'));
            });
        });



    </script>
</body>

</html>