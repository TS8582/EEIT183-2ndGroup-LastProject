<!DOCTYPE html>
<html lang="zh-Hant-TW" xmlns:th="http://www.thymeleaf.org/">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <div th:replace="~{/layout/nav}"></div>
    <link rel="stylesheet" th:href="@{/css/output.css}">
    <title th:text="${session.loginMember.nickname} + ' - ' + 購物車"></title>
</head>

<body class="bg-gray-100">
    <div class="hidden memId" th:text="${session.loginMember.memId}"></div>
    <div class="container mx-auto my-10">
        <div class="flex shadow-md my-10">
            <div class="w-full bg-white px-10 py-10 rounded-md">
                <div class="flex justify-between border-b pb-8">
                    <h1 class="font-semibold text-2xl">購物車</h1>
                    <h2 class="font-semibold text-2xl" th:text="${#lists.size(games)} + 款遊戲"></h2>
                </div>

                <div th:if="${games == null}">
                    <span>購物車目前沒有遊戲！</span>
                </div>

                <th:block th:if="${games}" th:each="game:${games}">
                    <div class="flex items-center hover:bg-gray-100 -mx-8 px-6 py-5 game">
                        <div class="hidden gameId" th:text="${game.gameId}"></div>
                        <div class="flex w-4/5">
                            <!-- 遊戲 -->
                            <div class="w-3/5 flex justify-center items-center">
                                <a th:if="${!game.imageLibs.empty}" th:href="@{/game/showGame(gameId=${game.gameId})}">
                                    <img class="h-32 lg:h-64 w-auto"
                                        th:src="@{/imagesLib/image{id}(id=${game.imageLibs[0].imageId})}" alt="產品圖片">
                                </a>
                                <a th:if="${game.imageLibs.empty}">
                                    <img class="h-32 lg:h-64 w-auto" alt="產品圖片">
                                </a>
                            </div>
                            <div class="flex flex-col justify-between ml-4 flex-grow w-2/5">
                                <a th:href="@{/game/showGame(gameId=${game.gameId})}" class="font-bold text-4xl"
                                    th:text="${game.gameName}"></a>
                                <span class="text-gray-600 font-semibold text-xl"
                                    th:text="發布日期： + ${#temporals.format(game.releaseAt,'yyyy年MM月dd日')}"></span>
                                <span
                                    class="text-lg text-red-600 bg-gray-300 max-w-max p-1 rounded-md font-semibold border border-black select-none cursor-pointer mybtn remove">移除</span>
                            </div>
                        </div>
                        <div class="w-1/5 text-end font-semibold text-lg">
                            <span class="">NT$</span>
                            <span class="price" th:text="${game.price}"></span>
                        </div>
                    </div>
                </th:block>

                <div class="flex justify-end items-center mt-10 space-x-10 font-semibold text-2xl">
                    <div class="">總價</div>
                    <div>
                        <span class="text-end">NT$</span>
                        <span class="text-end total"></span>
                    </div>
                </div>
                <div class="flex items-center justify-end text-2xl mt-5">
                    <span class="mybtn mybtn-green">結帳</span>
                </div>
            </div>
        </div>
    </div>

    <div class="h-px"></div>
    <script th:src="@{/js/axios.min.js}"></script>
    <script>
        const total = document.querySelector('.total');
        const price = document.querySelectorAll('.price');
        let totalPrice = 0;
        price.forEach(elm => {
            totalPrice += parseInt(elm.innerHTML);
        });
        total.innerHTML = totalPrice;

        const remove = document.querySelectorAll('.remove');
        remove.forEach(elm => {
            elm.addEventListener('click', e => {
                const gameId = parseInt(elm.closest('.game').querySelector('.gameId').innerHTML.trim());
                console.log(gameId);
                const memId = parseInt(document.querySelector('.memId').innerHTML.trim());
                axios.get('/PlayCentric/gamecart/remove', {
                    params: {
                        gameId: gameId,
                        memId: memId
                    }
                })
                    .then(res => {
                        console.log('成功移除');
                    })
                    .catch(err => {
                        console.error(err);
                    })
            })
        });
    </script>
</body>

</html>